<!DOCTYPE html>
<html>
<head>
  <title>check.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "src/check.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#run-a-check">Run a check</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#initialized-data">Initialized Data</a>
      </div>

      <div class="heading h2">
        <a href="#controller-class">Controller class</a>
      </div>

      <div class="heading h3">
        <a href="#general-initialization">General initialization</a>
      </div>

      <div class="heading h3">
        <a href="#create-instance">Create instance</a>
      </div>

      <div class="heading h3">
        <a href="#initialize-check-and-sensor">Initialize check and sensor</a>
      </div>

      <div class="heading h3">
        <a href="#run-one-sensor-check">Run one sensor check</a>
      </div>

      <div class="heading h3">
        <a href="#really-run-after-optional-prerun-call">Really run (after optional prerun call)</a>
      </div>

      <div class="heading h3">
        <a href="#create-text-report">create text report</a>
      </div>

      <div class="heading h2">
        <a href="#helper-methods-for-sensor">Helper methods for sensor</a>
      </div>

      <div class="heading h3">
        <a href="#check-expression-against-string">Check expression against string</a>
      </div>

      <div class="heading h2">
        <a href="#export-class">Export class</a>
      </div>

      <div class="heading h3">
        <a href="#format-a-value-for-better-human-readable-display">Format a value for better human readable display</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-monitor" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-a-check">
  <h1>
    <a href="#run-a-check" name="run-a-check" class="pilcrow"></a>
Run a check
  </h1>
</div>
<p>This will call the sensor and work with it. A sensor is not usable standalone
and needs a check which defines it's environment.</p>
<p>The sensor should have the following API:</p>
<ul>
<li>schema - validator compatible definition</li>
<li>meta - some meta informations</li>
<li>init() - setup of the sensor for this check</li>
<li>prerun() - run some initialization which have to be done before each run</li>
<li>run() - run the sensor for the check</li>
<li>calc() - check the results</li>
<li>report() - generate a report after run</li>
</ul>
<p>The sensor will use the storage instance for storing it's data and is called in
the context of the check.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
util = <span class="hljs-built_in">require</span> <span class="hljs-string">'util'</span>
EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter
vm = <span class="hljs-built_in">require</span> <span class="hljs-string">'vm'</span>
math = <span class="hljs-built_in">require</span> <span class="hljs-string">'mathjs'</span>
named = <span class="hljs-built_in">require</span>(<span class="hljs-string">'named-regexp'</span>).named
moment = <span class="hljs-built_in">require</span> <span class="hljs-string">'moment'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">validator = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-validator'</span>
Report = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-report'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include classes and helpers</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">storage = <span class="hljs-built_in">require</span> <span class="hljs-string">'./storage'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">HISTORY_LENGTH = <span class="hljs-number">5</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialized-data">
  <h2>
    <a href="#initialized-data" name="initialized-data" class="pilcrow"></a>
Initialized Data
  </h2>
</div>
<p>This will be set on init</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">monitor = <span class="hljs-literal">null</span>  <span class="hljs-comment"># require './index'</span>
mode = {}</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="controller-class">
  <h2>
    <a href="#controller-class" name="controller-class" class="pilcrow"></a>
Controller class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Check</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span></span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="general-initialization">
  <h3>
    <a href="#general-initialization" name="general-initialization" class="pilcrow"></a>
General initialization
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  @init: <span class="hljs-function"><span class="hljs-params">(setup, cb)</span> -&gt;</span>
    mode = setup
    cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-instance">
  <h3>
    <a href="#create-instance" name="create-instance" class="pilcrow"></a>
Create instance
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  constructor: <span class="hljs-function"><span class="hljs-params">(setup, @controller)</span> -&gt;</span>
    @type = setup.sensor
    @name = setup.name
    @depend = setup.depend
    @conf = setup.config ? {}
    @weight = setup.weight
    @hint = setup.hint</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>will be set after initialization</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @num = <span class="hljs-number">0</span> <span class="hljs-comment"># number of check in config</span>
    @sensor = <span class="hljs-literal">null</span>
    @databaseID = <span class="hljs-literal">null</span>
    @base = <span class="hljs-literal">null</span>
    @rule = <span class="hljs-literal">null</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>will be filled on run</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @err = <span class="hljs-literal">null</span>
    @date = []
    @result = {}
    @values = {}
    @status = <span class="hljs-string">'disabled'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>last results</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @history = []
    @changed = <span class="hljs-number">0</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialize-check-and-sensor">
  <h3>
    <a href="#initialize-check-and-sensor" name="initialize-check-and-sensor" class="pilcrow"></a>
Initialize check and sensor
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  init: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> @sensor?
    @rule =
      warn: @conf.warn
      fail: @conf.fail
    monitor ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'./index'</span>
    monitor.getSensor @type, <span class="hljs-function"><span class="hljs-params">(err, @sensor)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>check config</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      validator.check
        name: <span class="hljs-keyword">if</span> @controller <span class="hljs-keyword">then</span> <span class="hljs-string">"/controller/<span class="hljs-subst">#{@controller.name}</span>/check/<span class="hljs-subst">#{@num}</span>:<span class="hljs-subst">#{@type}</span>"</span>
        <span class="hljs-keyword">else</span> <span class="hljs-string">"/sensor:<span class="hljs-subst">#{@type}</span>"</span>
        value: @conf
        schema: @sensor.schema
      , <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
        @sensor.init.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
          <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
          @sensor.debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @name}</span> Initialized"</span>
          <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> @controller?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>only add database entry if run below controller</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          storage.check @controller.databaseID, @type, @name, @sensor.meta
          , <span class="hljs-function"><span class="hljs-params">(err, checkID)</span> =&gt;</span>
            <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
            @databaseID = checkID
            cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-one-sensor-check">
  <h3>
    <a href="#run-one-sensor-check" name="run-one-sensor-check" class="pilcrow"></a>
Run one sensor check
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  run: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>stop if already running</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> @status <span class="hljs-keyword">is</span> <span class="hljs-string">'running'</span>
      @date[<span class="hljs-number">1</span>] = <span class="hljs-keyword">new</span> Date()
      @err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">"Skipped test because it is called again while running."</span>
      @setStatus()
      <span class="hljs-keyword">return</span> cb @err, @status <span class="hljs-keyword">unless</span> @databaseID</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>store in database</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">return</span> storage.results @databaseID, @type, @sensor.meta.values
      , @date[<span class="hljs-number">0</span>], @values, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
        cb @err, @status
    @sensor.debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @name}</span> start check"</span>
    @status = <span class="hljs-string">'running'</span>
    <span class="hljs-keyword">return</span> @runNow cb <span class="hljs-keyword">unless</span> @sensor.prerun?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>call prerun first</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @sensor.prerun.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(@err)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> cb @err <span class="hljs-keyword">if</span> @err
      @runNow cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="really-run-after-optional-prerun-call">
  <h3>
    <a href="#really-run-after-optional-prerun-call" name="really-run-after-optional-prerun-call" class="pilcrow"></a>
Really run (after optional prerun call)
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  runNow: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    @err = <span class="hljs-literal">null</span>
    @date = [<span class="hljs-keyword">new</span> Date()]
    @values = {}
    @changed = <span class="hljs-number">0</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>run the sensor</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    started = @date[<span class="hljs-number">0</span>]
    @sensor.run.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(err, res)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">unless</span> started <span class="hljs-keyword">is</span> @date[<span class="hljs-number">0</span>]
      @err = err <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @err <span class="hljs-keyword">and</span> err
      @result.data = res
      @sensor.debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @name}</span> ended check"</span>
      @date[<span class="hljs-number">1</span>] = <span class="hljs-keyword">new</span> Date()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>calculate results</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      @sensor.calc.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
        @err = err <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @err <span class="hljs-keyword">and</span> err
        @setStatus()
        <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, @status <span class="hljs-keyword">unless</span> @databaseID</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>store in database</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        storage.results @databaseID, @type, @sensor.meta.values
        , @date[<span class="hljs-number">0</span>], @values, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
          @err = err <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @err <span class="hljs-keyword">and</span> err
          cb <span class="hljs-literal">null</span>, @status</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>set status from rules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  setStatus: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">for</span> n, v <span class="hljs-keyword">of</span> @values
      @sensor.debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @name}</span> result <span class="hljs-subst">#{n}</span>: <span class="hljs-subst">#{util.inspect v}</span>"</span>
    @calcStatus()
    @sensor.debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @name}</span> result status:
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>{@status}#{if @err then ' (' + @err.message + ')' else ''}&quot;
verbose output</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> mode.verbose &gt; <span class="hljs-number">1</span>
      <span class="hljs-built_in">console</span>.log chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{moment().format(<span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span>)}</span>
      Check <span class="hljs-subst">#{chalk.white @type+<span class="hljs-string">':'</span>+@name}</span> =&gt; <span class="hljs-subst">#{@controller.colorStatus @status}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>add to history</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @history.unshift
      status: @status
      date: @date
      values: @values
      err: @err
    @history.pop() <span class="hljs-keyword">while</span> @history.length &gt; HISTORY_LENGTH</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>return status</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @status</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>calculate status</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  calcStatus: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">return</span> @status = <span class="hljs-string">'fail'</span> <span class="hljs-keyword">if</span> @err</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>check for values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">unless</span> Object.keys @values
      @err = <span class="hljs-keyword">new</span> Error <span class="hljs-string">'no data'</span>
      <span class="hljs-keyword">return</span> @status = <span class="hljs-string">'fail'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>calculate from values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">for</span> status <span class="hljs-keyword">in</span> [<span class="hljs-string">'fail'</span>, <span class="hljs-string">'warn'</span>]
      <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> @rule[status]
      rule = @rule[status]
      @sensor.debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> check <span class="hljs-subst">#{status}</span> rule: <span class="hljs-subst">#{@conf[status]}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>replace data values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">of</span> @values
        <span class="hljs-keyword">if</span> Array.isArray value
          <span class="hljs-keyword">for</span> i, val <span class="hljs-keyword">in</span> value
            re = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">"\\b<span class="hljs-subst">#{name}</span>\\[<span class="hljs-subst">#{i}</span>\\]\\b"</span>, <span class="hljs-string">'g'</span>
            rule = rule.replace re, <span class="hljs-string">"'<span class="hljs-subst">#{value[i]?.toString()}</span>'"</span>
          re = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">"\\b<span class="hljs-subst">#{name}</span>\\b"</span>, <span class="hljs-string">'g'</span>
          rule = rule.replace re, <span class="hljs-string">"'<span class="hljs-subst">#{value.toString()}</span>'"</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
          <span class="hljs-keyword">for</span> i, val <span class="hljs-keyword">of</span> value
            re = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">"\\b<span class="hljs-subst">#{name}</span>\\.<span class="hljs-subst">#{i}</span>\\b"</span>, <span class="hljs-string">'g'</span>
            rule = rule.replace re, <span class="hljs-string">"'<span class="hljs-subst">#{value[i]?.toString()}</span>'"</span>
          re = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">"\\b<span class="hljs-subst">#{name}</span>\\b"</span>, <span class="hljs-string">'g'</span>
          rule = rule.replace re, <span class="hljs-string">"'<span class="hljs-subst">#{value.toString()}</span>'"</span>
        <span class="hljs-keyword">else</span>
          re = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">"\\b<span class="hljs-subst">#{name}</span>\\b"</span>, <span class="hljs-string">'g'</span>
          rule = rule.replace re, value</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>replace not existing data values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">if</span> @sensor.meta?.values?
        <span class="hljs-keyword">for</span> name <span class="hljs-keyword">of</span> @sensor.meta.values
          re = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">"\\b<span class="hljs-subst">#{name}</span>(\\.\\w+|\\[\\d+\\])?\\b"</span>, <span class="hljs-string">'g'</span>
          rule = rule.replace re, <span class="hljs-string">'null'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>replace percent values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      rule = rule.replace <span class="hljs-regexp">/\b(\d+(\.\d+)?)%/g</span>, <span class="hljs-function"><span class="hljs-params">(str, value)</span> -&gt;</span>
        value / <span class="hljs-number">100</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>replace binary values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      rule = rule.replace <span class="hljs-regexp">/\b(\d+(\.\d+)?)([kMGTPEYZ]?B)/g</span>, <span class="hljs-function"><span class="hljs-params">(str)</span> -&gt;</span>
        math.unit(str).toNumber(<span class="hljs-string">'B'</span>)</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>replace interval values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      rule = rule.replace <span class="hljs-regexp">/\b(\d+(\.\d+)?)(ms|s|m|h|d)/g</span>, <span class="hljs-function"><span class="hljs-params">(str)</span> -&gt;</span>
        Number.parseMSeconds str</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>replace operators</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">for</span> name, value <span class="hljs-keyword">of</span> {and: <span class="hljs-string">'&amp;&amp;'</span>, or: <span class="hljs-string">'||'</span>, is: <span class="hljs-string">'=='</span>, isnt: <span class="hljs-string">'!='</span>, not: <span class="hljs-string">'!'</span>}
        re = <span class="hljs-keyword">new</span> RegExp <span class="hljs-string">"\\b<span class="hljs-subst">#{name}</span>\\b"</span>, <span class="hljs-string">'g'</span>
        rule = rule.replace re, value
      @sensor.debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> optimized: <span class="hljs-subst">#{rule}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>run the code in sandbox</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      sandbox = {}
      vm.runInNewContext <span class="hljs-string">"result = <span class="hljs-subst">#{rule}</span>"</span>, sandbox, {filename: <span class="hljs-string">"sensor-<span class="hljs-subst">#{@type}</span>:<span class="hljs-subst">#{@name}</span>.vm"</span>}
      @sensor.debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{@name}</span> rule result: <span class="hljs-subst">#{status}</span> = <span class="hljs-subst">#{sandbox.result}</span>"</span>
      <span class="hljs-keyword">if</span> sandbox.result
        @err = <span class="hljs-keyword">new</span> Error @conf[status]
        <span class="hljs-keyword">return</span> @status = status
    @status = <span class="hljs-string">'ok'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-text-report">
  <h3>
    <a href="#create-text-report" name="create-text-report" class="pilcrow"></a>
create text report
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  report: <span class="hljs-function">-&gt;</span>
    last = @history[@history.length - <span class="hljs-number">1</span>]
    report = <span class="hljs-keyword">new</span> Report()
    report.h2 <span class="hljs-string">"<span class="hljs-subst">#{@sensor.meta.title}</span> <span class="hljs-subst">#{@name}</span>"</span>
    report.p @sensor.meta.description</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40"></a>
</div>
<p>status box</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    boxtype =
      warn: <span class="hljs-string">'warning'</span>
      fail: <span class="hljs-string">'alert'</span>
    <span class="hljs-keyword">if</span> @history.length
      list = Report.ul @history.map (e) -&gt;
        <span class="hljs-string">"__STATUS <span class="hljs-subst">#{e.status}</span>__ at <span class="hljs-subst">#{e.date[<span class="hljs-number">0</span>]}</span>
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41"></a>
</div>
<p>{if e.err then '\\nBecause ' + e.err.message else ''}&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      report.box list, boxtype[@status] ? <span class="hljs-string">'info'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>table with max. last 3 values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> @date.length
      report.p <span class="hljs-string">"Last check results from <span class="hljs-subst">#{last.date[<span class="hljs-number">0</span>]}</span> are:"</span>
      data = []
      <span class="hljs-keyword">for</span> key, conf <span class="hljs-keyword">of</span> @sensor.meta.values
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> value = last.values[key]</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>support mappings from database sensor</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">if</span> @sensor.mapping?
          nconf = @sensor.mapping.call <span class="hljs-keyword">this</span>, key
          conf = nconf <span class="hljs-keyword">if</span> nconf</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>add rows</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span> <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> Array.isArray value
          <span class="hljs-keyword">for</span> k <span class="hljs-keyword">of</span> value
            row = [key, <span class="hljs-string">"<span class="hljs-subst">#{conf.title ? key}</span>.<span class="hljs-subst">#{k}</span>"</span>]
            row.push formatValue e.values[key][k], conf <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> @history[.<span class="hljs-number">.2</span>]
            data.push row
        <span class="hljs-keyword">else</span>
          row = [conf.name ? key, conf.title ? key]
          <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> @history[.<span class="hljs-number">.2</span>]
            row.push formatValue e.values[key], conf
          data.push row
      col =
        <span class="hljs-number">0</span>:
          title: <span class="hljs-string">'NAME'</span>
        <span class="hljs-number">1</span>:
          title: <span class="hljs-string">'LABEL'</span>
        <span class="hljs-number">2</span>:
          title: <span class="hljs-string">'VALUE'</span>
          align: <span class="hljs-string">'right'</span>
      <span class="hljs-keyword">if</span> @history.length &gt; <span class="hljs-number">1</span>
        num = <span class="hljs-number">2</span>
        <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> @history[<span class="hljs-number">1.</span><span class="hljs-number">.2</span>]
          col[++num] = {title: <span class="hljs-string">'PREVIOUS'</span>, align: <span class="hljs-string">'right'</span>}
      report.table data, col</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45"></a>
</div>
<p>special report details</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> @sensor.report?
      report.add @sensor.report.call <span class="hljs-keyword">this</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46"></a>
</div>
<p>additional hints</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> @sensor.meta.hint
      report.quote @sensor.meta.hint
    <span class="hljs-keyword">if</span> @hint
      report.quote @hint</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47"></a>
</div>
<p>configuration</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    report.h3 <span class="hljs-string">'Configuration'</span>
    report.p <span class="hljs-string">"The <span class="hljs-subst">#{@type}</span> sensor is configured with:"</span>
    c = {}
    <span class="hljs-keyword">for</span> key, meta <span class="hljs-keyword">of</span> @sensor.schema.keys
      <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> key <span class="hljs-keyword">is</span> <span class="hljs-string">'mapping'</span>
      c[key] = <span class="hljs-keyword">if</span> @conf[key]
        formatValue @conf[key], meta
      <span class="hljs-keyword">else</span> <span class="hljs-string">'---'</span>
    report.table c, [<span class="hljs-string">'CONFIGURATION SETTING'</span>, <span class="hljs-string">'VALUE'</span>]
    <span class="hljs-keyword">return</span> report</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper-methods-for-sensor">
  <h2>
    <a href="#helper-methods-for-sensor" name="helper-methods-for-sensor" class="pilcrow"></a>
Helper methods for sensor
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="check-expression-against-string">
  <h3>
    <a href="#check-expression-against-string" name="check-expression-against-string" class="pilcrow"></a>
Check expression against string
  </h3>
</div>
<p>It will will try to match the given expression once and return the matched
groups or false if not matched. The groups are an array with the full match as
first element or in case of named regexp an object with key 'match' containing
the full match.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  match: <span class="hljs-function"><span class="hljs-params">(text, re)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> re?
    <span class="hljs-keyword">unless</span> re <span class="hljs-keyword">instanceof</span> RegExp
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">if</span> Boolean ~text.indexOf re <span class="hljs-keyword">then</span> [re] <span class="hljs-keyword">else</span> <span class="hljs-literal">false</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-50" id="section-50"></a>
</div>
<p>it's an regular expression</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    useNamed = ~re.toString().indexOf <span class="hljs-string">'(:&lt;'</span>
    re = named re <span class="hljs-keyword">if</span> useNamed
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span> <span class="hljs-keyword">unless</span> match = re.exec text
    <span class="hljs-keyword">if</span> useNamed
      matches = {}
      matches[name] = match.capture name <span class="hljs-keyword">for</span> name <span class="hljs-keyword">of</span> match.captures
    <span class="hljs-keyword">else</span>
      matches = match[<span class="hljs-number">0.</span>.match.length]
    <span class="hljs-keyword">return</span> matches</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="export-class">
  <h2>
    <a href="#export-class" name="export-class" class="pilcrow"></a>
Export class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
<span class="hljs-built_in">module</span>.exports =  Check</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="format-a-value-for-better-human-readable-display">
  <h3>
    <a href="#format-a-value-for-better-human-readable-display" name="format-a-value-for-better-human-readable-display" class="pilcrow"></a>
Format a value for better human readable display
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">Check.formatValue = formatValue = <span class="hljs-function"><span class="hljs-params">(value, config)</span> -&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-53" id="section-53"></a>
</div>
<p>format with autodetect</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">unless</span> config
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">switch</span>
      <span class="hljs-keyword">when</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">'number'</span>
        parts = (Math.round(value * <span class="hljs-number">100</span>) / <span class="hljs-number">100</span>).toString().split <span class="hljs-string">'.'</span>
        parts[<span class="hljs-number">0</span>] = parts[<span class="hljs-number">0</span>].replace <span class="hljs-regexp">/\B(?=(\d{3})+(?!\d))/g</span>, <span class="hljs-string">","</span>
        parts.join <span class="hljs-string">'.'</span>
      <span class="hljs-keyword">else</span>
        value</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-54" id="section-54"></a>
</div>
<p>format using config setting</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">switch</span> config.type
    <span class="hljs-keyword">when</span> <span class="hljs-string">'percent'</span>
      math.format(value*<span class="hljs-number">100</span>, <span class="hljs-number">2</span>) + <span class="hljs-string">' %'</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">'byte'</span>
      byte = math.unit value, <span class="hljs-string">'B'</span>
      byte.format <span class="hljs-number">3</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">'interval'</span>
      long =
        d: <span class="hljs-string">'day'</span>
        m: <span class="hljs-string">'minute'</span>
      unit = long[config.unit] ? config.unit
      interval = math.unit value, unit
      interval = interval.to <span class="hljs-string">'min'</span> <span class="hljs-keyword">if</span> interval.toNumber(<span class="hljs-string">'s'</span>) &gt; <span class="hljs-number">120</span>
      interval = interval.to <span class="hljs-string">'h'</span> <span class="hljs-keyword">if</span> interval.toNumber(<span class="hljs-string">'min'</span>) &gt; <span class="hljs-number">120</span>
      interval = interval.to <span class="hljs-string">'day'</span> <span class="hljs-keyword">if</span> interval.toNumber(<span class="hljs-string">'h'</span>) &gt; <span class="hljs-number">48</span>
      interval.format <span class="hljs-number">2</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">'float'</span>, <span class="hljs-string">'integer'</span>
      value = Number value <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> value <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span>
      <span class="hljs-keyword">if</span> config.unit?
        math.unit(value, config.unit).format <span class="hljs-number">3</span>
      <span class="hljs-keyword">else</span>
        math.format Number(value), <span class="hljs-number">3</span>
    <span class="hljs-keyword">when</span> <span class="hljs-string">'array'</span>
      val = value[<span class="hljs-number">0.</span><span class="hljs-number">.9</span>].join <span class="hljs-string">', '</span>
      val += <span class="hljs-string">'...'</span> <span class="hljs-keyword">if</span> value.length &gt; <span class="hljs-number">10</span>
      val
    <span class="hljs-keyword">when</span> <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">switch</span> <span class="hljs-keyword">typeof</span> value
        <span class="hljs-keyword">when</span> <span class="hljs-string">'string'</span>, <span class="hljs-string">'number'</span>
          value
        <span class="hljs-keyword">else</span>
          <span class="hljs-keyword">if</span> Array.isArray value
            val = value[<span class="hljs-number">0.</span><span class="hljs-number">.9</span>].join <span class="hljs-string">', '</span>
            val += <span class="hljs-string">'...'</span> <span class="hljs-keyword">if</span> value.length &gt; <span class="hljs-number">10</span>
            val
          <span class="hljs-keyword">else</span>
            util.inspect(value).replace <span class="hljs-regexp">/\n/g</span>, <span class="hljs-string">' '</span>
    <span class="hljs-keyword">else</span>
      val = value
      val += <span class="hljs-string">" <span class="hljs-subst">#{config.unit}</span>"</span> <span class="hljs-keyword">if</span> value <span class="hljs-keyword">and</span> config.unit
      val</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
