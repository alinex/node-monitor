<!DOCTYPE html>
<html>
<head>
  <title>action.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "src/action.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#run-an-action-rules">Run an action rules</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#initialized-data">Initialized Data</a>
      </div>

      <div class="heading h2">
        <a href="#controller-class">Controller class</a>
      </div>

      <div class="heading h2">
        <a href="#initialize-rule-data">Initialize rule data</a>
      </div>

      <div class="heading h2">
        <a href="#run-all-action-rules">Run all action rules</a>
      </div>

      <div class="heading h3">
        <a href="#create-instance">Create instance</a>
      </div>

      <div class="heading h3">
        <a href="#initialize-check-and-actor">Initialize check and actor</a>
      </div>

      <div class="heading h3">
        <a href="#check-the-rules-and-run-actor">Check the Rules and run Actor</a>
      </div>

      <div class="heading h1">
        <a href="#number-of-minimum-attempts-controller-runs-before-informing">number of minimum attempts (controller runs) before informing.</a>
      </div>

      <div class="heading h3">
        <a href="#prerun">Prerun</a>
      </div>

      <div class="heading h3">
        <a href="#run-actor">Run Actor</a>
      </div>

      <div class="heading h2">
        <a href="#export-class">Export class</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-monitor" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-an-action-rules">
  <h1>
    <a href="#run-an-action-rules" name="run-an-action-rules" class="pilcrow"></a>
Run an action rules
  </h1>
</div>
<p>This will call the actor and work with it. A actor is not usable standalone
and needs a action which defines it's environment.</p>
<p>The static class methods will be called in the controller context.</p>
<p>The actor should have the following API:</p>
<ul>
<li>schema - validator compatible definition</li>
<li>meta - some meta informations</li>
<li>init() - setup of the actor for this check</li>
<li>prerun() - run some initialization which have to be done before each run</li>
<li>run() - run the actor for the check</li>
<li>report() - generate a report after run</li>
</ul>
<p>The actors will use the storage instance for storing it's data and is called in
the context of the action.</p>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'monitor:action'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter
moment = <span class="hljs-built_in">require</span> <span class="hljs-string">'moment'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">validator = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-validator'</span>
config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
{object} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include classes and helpers</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">storage = <span class="hljs-built_in">require</span> <span class="hljs-string">'./storage'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialized-data">
  <h2>
    <a href="#initialized-data" name="initialized-data" class="pilcrow"></a>
Initialized Data
  </h2>
</div>
<p>This will be set on init</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">monitor = <span class="hljs-literal">null</span>  <span class="hljs-comment"># require './index'</span>
mode = {}
actors = <span class="hljs-literal">null</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="controller-class">
  <h2>
    <a href="#controller-class" name="controller-class" class="pilcrow"></a>
Controller class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Action</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span></span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialize-rule-data">
  <h2>
    <a href="#initialize-rule-data" name="initialize-rule-data" class="pilcrow"></a>
Initialize rule data
  </h2>
</div>
<p>This will be called after controller is initialized.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  @init: <span class="hljs-function"><span class="hljs-params">(setup, cb)</span> -&gt;</span>
    mode = setup</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>set actions object in the controller</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @actions = []</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>setup actors</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    monitor ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'./index'</span>
    actors = monitor.listActor()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>resolve rules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    rules = config.get <span class="hljs-string">'/monitor/rule'</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>set specific one</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">for</span> rule, num <span class="hljs-keyword">in</span> @conf.rule</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>use base settings</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">while</span> rule.base
        <span class="hljs-keyword">unless</span> base = rules[rule.base]
          <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"No base rule with name <span class="hljs-subst">#{rule.base}</span> defined, like used
          in <span class="hljs-subst">#{rule.name}</span> rule of <span class="hljs-subst">#{@controller?.name}</span> controller"</span>
        <span class="hljs-keyword">delete</span> rule.base
        rule = object.extend {}, base, rule
      rule.name ?= <span class="hljs-string">"#<span class="hljs-subst">#{num}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<pre><code> rule = rules[name]
</code></pre>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">try</span>
        <span class="hljs-keyword">if</span> rule.email
          @actions.push <span class="hljs-keyword">new</span> Action rule, <span class="hljs-keyword">this</span>
        <span class="hljs-keyword">else</span>
          @actions.unshift <span class="hljs-keyword">new</span> Action rule, <span class="hljs-keyword">this</span>
      <span class="hljs-keyword">catch</span> error
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{error.message}</span> <span class="hljs-subst">#{error.stack.split(<span class="hljs-regexp">/\n/</span>)[<span class="hljs-number">1</span>].trim()}</span>
        in <span class="hljs-subst">#{rule.name}</span> rule of <span class="hljs-subst">#{@controller?.name}</span> controller"</span>
    cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-all-action-rules">
  <h2>
    <a href="#run-all-action-rules" name="run-all-action-rules" class="pilcrow"></a>
Run all action rules
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  @run: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    async.each @actions, <span class="hljs-function"><span class="hljs-params">(action, cb)</span> -&gt;</span>
      action.run cb
    , cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-instance">
  <h3>
    <a href="#create-instance" name="create-instance" class="pilcrow"></a>
Create instance
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  constructor: <span class="hljs-function"><span class="hljs-params">(@conf, @controller)</span> -&gt;</span>
    @count = <span class="hljs-number">0</span> <span class="hljs-comment"># number of calls in current status</span>
    @date = @controller?.date <span class="hljs-comment"># last change of status</span>
    @status = @controller?.status <span class="hljs-comment"># last status</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>will be set on init</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @type = <span class="hljs-literal">null</span> <span class="hljs-comment"># list actor</span>
    @base = <span class="hljs-literal">null</span> <span class="hljs-comment"># template</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>actor specific</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @actor = <span class="hljs-literal">null</span> <span class="hljs-comment"># list actor</span>
    @lastrun = <span class="hljs-literal">null</span> <span class="hljs-comment"># date of last actor run</span>
    @err = <span class="hljs-literal">null</span> <span class="hljs-comment"># last error</span>
    @values = {} <span class="hljs-comment"># last results</span>
    @init()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialize-check-and-actor">
  <h3>
    <a href="#initialize-check-and-actor" name="initialize-check-and-actor" class="pilcrow"></a>
Initialize check and actor
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  init: <span class="hljs-function">-&gt;</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>check that rule is defined</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">unless</span> @conf
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error <span class="hljs-string">"No definition for rule <span class="hljs-subst">#{@conf.name}</span>"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>set actor list</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    monitor ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'./index'</span>
    <span class="hljs-keyword">for</span> type <span class="hljs-keyword">in</span> actors
      <span class="hljs-keyword">continue</span> <span class="hljs-keyword">unless</span> @conf[type]
      @type = type
      @base = @conf[type]
    debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @controller?.name}</span> initialized <span class="hljs-subst">#{@conf.name}</span> rule"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="check-the-rules-and-run-actor">
  <h3>
    <a href="#check-the-rules-and-run-actor" name="check-the-rules-and-run-actor" class="pilcrow"></a>
Check the Rules and run Actor
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  run: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @controller? <span class="hljs-keyword">or</span> @controller.changed
      @count = <span class="hljs-number">0</span>
      @date = @controller?.date ? <span class="hljs-keyword">new</span> Date()
    debug chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{@controller?.name}</span> check <span class="hljs-subst">#{@conf.name}</span> rule"</span>
    @count++</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>only work on specific status</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> @conf.status <span class="hljs-keyword">is</span> @controller?.status</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <p>TODO reenable if not testing</p>
<div class="pilwrap" id="number-of-minimum-attempts-controller-runs-before-informing">
  <h1>
    <a href="#number-of-minimum-attempts-controller-runs-before-informing" name="number-of-minimum-attempts-controller-runs-before-informing" class="pilcrow"></a>
number of minimum attempts (controller runs) before informing.
  </h1>
</div>
<p>return cb() if @conf.attempt and @count &lt; @conf.attempt
time (in seconds) to wait before informing.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    now = <span class="hljs-keyword">new</span> Date()
    <span class="hljs-keyword">if</span> @conf.latency
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> now &lt; moment(@date).add(@conf.latency, <span class="hljs-string">'seconds'</span>).toDate()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>if already done and not in redo time</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> @lastrun?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Timeout (in seconds) without status change before informing again.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">if</span> @conf.redo
        <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> now &lt; moment(@lastrun).add(@conf.redo, <span class="hljs-string">'seconds'</span>).toDate()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>don't run if no redo defined</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">else</span>
        <span class="hljs-keyword">return</span> cb()</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>TODO reenable if not testing
else if @controller?.status is 'ok' and not @controller?.cahnged
return cb()
run actor</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">return</span> @prerun cb <span class="hljs-keyword">if</span> @actor</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>initialize actor first</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    monitor.getActor @type, <span class="hljs-function"><span class="hljs-params">(err, @actor)</span> =&gt;</span>
      <span class="hljs-keyword">if</span> err
        <span class="hljs-keyword">return</span> cb <span class="hljs-keyword">new</span> Error <span class="hljs-string">"<span class="hljs-subst">#{err.message}</span> in <span class="hljs-subst">#{@conf.name}</span> rule
        of <span class="hljs-subst">#{@controller?.name}</span> controller"</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>check config</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      validator.check
        name: <span class="hljs-keyword">if</span> @controller <span class="hljs-keyword">then</span> <span class="hljs-string">"/controller/<span class="hljs-subst">#{@controller?.name}</span>/action/<span class="hljs-subst">#{@conf.name}</span>/<span class="hljs-subst">#{@type}</span>"</span>
        <span class="hljs-keyword">else</span> <span class="hljs-string">"/actor:<span class="hljs-subst">#{@type}</span>"</span>
        value: @conf[@type]
        schema: @actor.schema
        , <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
          <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
          @actor.init.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
            <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
            @prerun cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="prerun">
  <h3>
    <a href="#prerun" name="prerun" class="pilcrow"></a>
Prerun
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  prerun: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> @runNow cb <span class="hljs-keyword">unless</span> @actor.prerun?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>call prerun first</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    @actor.prerun.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(@err)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> cb @err <span class="hljs-keyword">if</span> @err
      @runNow cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-actor">
  <h3>
    <a href="#run-actor" name="run-actor" class="pilcrow"></a>
Run Actor
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  runNow: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    @actor.debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @controller?.name}</span> run <span class="hljs-subst">#{@conf.name}</span> actor"</span>
    @err = <span class="hljs-literal">null</span>
    @values = {}
    @lastrun = [<span class="hljs-keyword">new</span> Date()]
    @actor.run.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
      @lastrun.push <span class="hljs-keyword">new</span> Date()
      @err = err <span class="hljs-keyword">if</span> <span class="hljs-keyword">not</span> @err <span class="hljs-keyword">and</span> err
      @actor.debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey @controller?.name}</span> finished <span class="hljs-subst">#{@conf.name}</span> actor"</span>
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> @controller?</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>add database entry if run below controller</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      storage.action @databaseID, @type, @actor.meta.values
      , @date, @values, cb</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="export-class">
  <h2>
    <a href="#export-class" name="export-class" class="pilcrow"></a>
Export class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports =  Action</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
