<!DOCTYPE html>
<html>
<head>
  <title>controller.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-monitor/src/controller.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#controller-for-specific-element">Controller for specific element</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#initialized-data">Initialized Data</a>
      </div>

      <div class="heading h2">
        <a href="#controller-class">Controller class</a>
      </div>

      <div class="heading h3">
        <a href="#general-initialization">General initialization</a>
      </div>

      <div class="heading h3">
        <a href="#create-instance">Create instance</a>
      </div>

      <div class="heading h3">
        <a href="#initialize">Initialize</a>
      </div>

      <div class="heading h3">
        <a href="#start-in-loop">Start in Loop</a>
      </div>

      <div class="heading h3">
        <a href="#run-once">Run once</a>
      </div>

      <div class="heading h3">
        <a href="#create-a-report">Create a report</a>
      </div>

      <div class="heading h2">
        <a href="#helper-to-colorize-output">Helper to colorize output</a>
      </div>

      <div class="heading h2">
        <a href="#export-class">Export class</a>
      </div>

      <div class="heading h2">
        <a href="#calculating-controller-status">Calculating Controller Status</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-monitor" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="controller-for-specific-element">
  <h1>
    <a href="#controller-for-specific-element" name="controller-for-specific-element" class="pilcrow"></a>
Controller for specific element
  </h1>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'monitor:controller'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
EventEmitter = <span class="hljs-built_in">require</span>(<span class="hljs-string">'events'</span>).EventEmitter
moment = <span class="hljs-built_in">require</span> <span class="hljs-string">'moment'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
{string} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
Report = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-report'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include classes and helpers</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">storage = <span class="hljs-built_in">require</span> <span class="hljs-string">'./storage'</span>
Check = <span class="hljs-built_in">require</span> <span class="hljs-string">'./check'</span>
Action = <span class="hljs-built_in">require</span> <span class="hljs-string">'./action'</span>
schema = <span class="hljs-built_in">require</span> <span class="hljs-string">'./configSchema'</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>
<p>maximum number of localy stored values for reporting</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">HISTORY_LENGTH = <span class="hljs-number">5</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialized-data">
  <h2>
    <a href="#initialized-data" name="initialized-data" class="pilcrow"></a>
Initialized Data
  </h2>
</div>
<p>This will be set on init</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">monitor = <span class="hljs-literal">null</span>  <span class="hljs-comment"># require './index'</span>
mode = {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="controller-class">
  <h2>
    <a href="#controller-class" name="controller-class" class="pilcrow"></a>
Controller class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Controller</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">EventEmitter</span></span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="general-initialization">
  <h3>
    <a href="#general-initialization" name="general-initialization" class="pilcrow"></a>
General initialization
  </h3>
</div>
<p>have to be run only once</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-property">@init</span>: <span class="hljs-function"><span class="hljs-params">(setup, cb)</span> -&gt;</span>
    mode = setup
    Check.init setup, cb

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-instance">
  <h3>
    <a href="#create-instance" name="create-instance" class="pilcrow"></a>
Create instance
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">constructor</span>: <span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@name</span>, <span class="hljs-property">@conf</span>)</span> -&gt;</span>
    <span class="hljs-property">@check</span> = [] <span class="hljs-comment"># Instances added on initialization</span>
    <span class="hljs-property">@timeout</span> = <span class="hljs-literal">null</span> <span class="hljs-comment"># timer for next run</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>set on initialization</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@queue</span> = {}
    <span class="hljs-property">@alias</span> = {} <span class="hljs-comment"># name reference to check</span>
    <span class="hljs-property">@actions</span> = <span class="hljs-literal">null</span> <span class="hljs-comment"># set from action rules</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Data storage with last results</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@status</span> = <span class="hljs-string">'disabled'</span> <span class="hljs-comment"># Last status</span>
    <span class="hljs-property">@date</span> = <span class="hljs-literal">null</span> <span class="hljs-comment"># last run</span>
    <span class="hljs-property">@err</span> = <span class="hljs-literal">null</span>
    <span class="hljs-property">@report</span> = <span class="hljs-literal">null</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>last results</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@history</span> = []
    <span class="hljs-property">@changed</span> = <span class="hljs-number">0</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialize">
  <h3>
    <a href="#initialize" name="initialize" class="pilcrow"></a>
Initialize
  </h3>
</div>
<p>should be called after new instance is created once</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">init</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span>
    debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey <span class="hljs-property">@name</span>}</span> Initialize controller..."</span>
    monitor ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'./index'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>create base data in storage</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    storage.controller <span class="hljs-property">@name</span>, <span class="hljs-function"><span class="hljs-params">(err, <span class="hljs-property">@databaseID</span>)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      async.each <span class="hljs-property">@conf</span>.check, <span class="hljs-function"><span class="hljs-params">(setup, cb)</span> =&gt;</span>
        check = <span class="hljs-keyword">new</span> Check setup, <span class="hljs-keyword">this</span>
        <span class="hljs-property">@check</span>.push check
        check.init cb
      , <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>get named references</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.<span class="hljs-property">@check</span>.length-<span class="hljs-number">1</span>]
          <span class="hljs-property">@check</span>.num = num
          <span class="hljs-property">@alias</span>[num] = <span class="hljs-property">@check</span>[num]
          <span class="hljs-keyword">if</span> <span class="hljs-property">@check</span>[num].name
            <span class="hljs-property">@alias</span>[<span class="hljs-property">@check</span>[num].name] = <span class="hljs-property">@check</span>[num]
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>create a work queue for checks</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-property">@queue</span> = {}
        <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>.<span class="hljs-property">@check</span>.length-<span class="hljs-number">1</span>]
          check = <span class="hljs-property">@check</span>[num]
          <span class="hljs-keyword">if</span> <span class="hljs-property">@check</span>[num].depend
            args = <span class="hljs-property">@check</span>[num].depend.slice()
            args.push check.run.bind check
            <span class="hljs-property">@queue</span>[<span class="hljs-property">@check</span>[num].conf.name ? num] = args
          <span class="hljs-keyword">else</span>
            <span class="hljs-property">@queue</span>[check.conf.name ? num] =  check.run.bind check
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>initialize action rules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        Action.init.call <span class="hljs-keyword">this</span>, mode, <span class="hljs-function"><span class="hljs-params">(err)</span> =&gt;</span>
          <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
          debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey <span class="hljs-property">@name</span>}</span> Initialized controller"</span>
          cb()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="start-in-loop">
  <h3>
    <a href="#start-in-loop" name="start-in-loop" class="pilcrow"></a>
Start in Loop
  </h3>
</div>
<p>run the controller in a daemon like mannerism</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">start</span>: <span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@conf</span>.disabled
      <span class="hljs-built_in">console</span>.log chalk.grey <span class="hljs-string">"Controller <span class="hljs-subst">#{<span class="hljs-property">@name</span>}</span> is disabled!"</span>
      <span class="hljs-keyword">return</span>
    <span class="hljs-property">@run</span>()
    <span class="hljs-property">@timeout</span> = setTimeout =&gt;
      <span class="hljs-property">@start</span>()
    , <span class="hljs-property">@conf</span>.interval * <span class="hljs-number">1000</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>Stop Controller
after started with above method</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">stop</span>: <span class="hljs-function">-&gt;</span>
    debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey <span class="hljs-property">@name</span>}</span> Stopped daemon mode"</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="run-once">
  <h3>
    <a href="#run-once" name="run-once" class="pilcrow"></a>
Run once
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">run</span>: <span class="hljs-function"><span class="hljs-params">(cb = -&gt;)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>for each sensor in parallel</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-property">@status</span> = <span class="hljs-string">'running'</span>
    async.auto <span class="hljs-property">@queue</span>, <span class="hljs-property">@conf</span>.parallel, <span class="hljs-function"><span class="hljs-params">(err, res)</span> =&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-property">@date</span> = <span class="hljs-keyword">new</span> Date()
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>calculate controller status</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      status = calcStatus <span class="hljs-property">@conf</span>.combine, <span class="hljs-property">@conf</span>.check, res
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>check for status change and store it</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      storage.statusController <span class="hljs-property">@databaseID</span>, <span class="hljs-keyword">new</span> Date(), status, <span class="hljs-function"><span class="hljs-params">(err, changed)</span> =&gt;</span>
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>store new values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-property">@changed</span> = changed ? status <span class="hljs-keyword">isnt</span> <span class="hljs-property">@status</span>
        <span class="hljs-property">@status</span> = status
        <span class="hljs-keyword">if</span> mode.verbose <span class="hljs-keyword">or</span> <span class="hljs-property">@status</span> <span class="hljs-keyword">isnt</span> <span class="hljs-string">'ok'</span>
          <span class="hljs-built_in">console</span>.log chalk.grey <span class="hljs-string">"<span class="hljs-subst">#{moment().format(<span class="hljs-string">"YYYY-MM-DD HH:mm:ss"</span>)}</span>
          Controller <span class="hljs-subst">#{chalk.white <span class="hljs-property">@name</span>}</span> =&gt; <span class="hljs-subst">#{<span class="hljs-property">@colorStatus</span>()}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>add to history</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-property">@history</span>.unshift
          <span class="hljs-attribute">status</span>: <span class="hljs-property">@status</span>
          <span class="hljs-attribute">date</span>: <span class="hljs-property">@date</span>
          <span class="hljs-attribute">err</span>: <span class="hljs-property">@err</span>
        <span class="hljs-property">@history</span>.pop() <span class="hljs-keyword">while</span> <span class="hljs-property">@history</span>.length &gt; HISTORY_LENGTH
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>info</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        debug <span class="hljs-string">"<span class="hljs-subst">#{chalk.grey <span class="hljs-property">@name</span>}</span> Controller =&gt; <span class="hljs-subst">#{<span class="hljs-property">@colorStatus</span>()}</span>
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>{if changed then 'CHANGED' else ''}&quot;.trim()
make report</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-property">@report</span> = <span class="hljs-property">@createReport</span>()
        <span class="hljs-keyword">if</span> mode.verbose &gt; <span class="hljs-number">2</span>
          <span class="hljs-built_in">console</span>.error <span class="hljs-string">"\n<span class="hljs-subst">#{report.toConsole()}</span>\n"</span>
        <span class="hljs-property">@emit</span> <span class="hljs-string">'result'</span>, <span class="hljs-keyword">this</span>
        Action.run.call <span class="hljs-keyword">this</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
          <span class="hljs-built_in">console</span>.error chalk.red.bold <span class="hljs-string">"Action failed because <span class="hljs-subst">#{err.message}</span>"</span> <span class="hljs-keyword">if</span> err
          cb <span class="hljs-literal">null</span>, <span class="hljs-property">@status</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-a-report">
  <h3>
    <a href="#create-a-report" name="create-a-report" class="pilcrow"></a>
Create a report
  </h3>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">createReport</span>: <span class="hljs-function">-&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>make report</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    context =
      <span class="hljs-attribute">name</span>: <span class="hljs-property">@name</span>
      <span class="hljs-attribute">config</span>: <span class="hljs-property">@conf</span>
    report = <span class="hljs-keyword">new</span> Report()
    report.toc()
    report.h1 <span class="hljs-property">@conf</span>.name
    report.p <span class="hljs-property">@conf</span>.description <span class="hljs-keyword">if</span> <span class="hljs-property">@conf</span>.description
    report.p <span class="hljs-property">@conf</span>.info <span class="hljs-keyword">if</span> <span class="hljs-property">@conf</span>.info
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>status box</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    boxtype =
      <span class="hljs-attribute">warn</span>: <span class="hljs-string">'warning'</span>
      <span class="hljs-attribute">fail</span>: <span class="hljs-string">'alert'</span>
    list = Report.ul <span class="hljs-property">@history</span>.map (e) -&gt;
      <span class="hljs-string">"__STATUS: <span class="hljs-subst">#{e.status}</span>__ at <span class="hljs-subst">#{e.date}</span>"</span>
    report.box list, boxtype[<span class="hljs-property">@status</span>] ? <span class="hljs-string">'info'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>more info</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> <span class="hljs-property">@conf</span>.hint <span class="hljs-keyword">and</span> <span class="hljs-property">@status</span> <span class="hljs-keyword">isnt</span> <span class="hljs-string">'ok'</span>
      report.quote <span class="hljs-property">@conf</span>.hint context
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33"></a>
</div>
<p>overview of checks</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    report.h2 <span class="hljs-string">"Check Overview"</span>
    report.p <span class="hljs-string">"The following checks will run but max. <span class="hljs-subst">#{<span class="hljs-property">@conf</span>.parallel}</span> checks in
    parallel.:"</span>
    report.ul <span class="hljs-property">@check</span>.map (e) -&gt;
      text = <span class="hljs-string">"<span class="hljs-subst">#{e.type}</span> <span class="hljs-subst">#{e.name}</span>"</span>
      text += <span class="hljs-string">" (weight <span class="hljs-subst">#{e.weight}</span>)"</span> <span class="hljs-keyword">if</span> e.weight
      text += <span class="hljs-string">" (depend on <span class="hljs-subst">#{e.depend.join <span class="hljs-string">', '</span>}</span>)"</span> <span class="hljs-keyword">if</span> e.depend
      text
    combine =
      <span class="hljs-attribute">max</span>: <span class="hljs-string">"The most critical status type of the checks is used for the controller."</span>
      <span class="hljs-attribute">min</span>: <span class="hljs-string">"The least critical status type of the checks is used for the controller."</span>
      <span class="hljs-attribute">average</span>: <span class="hljs-string">"The average status type of the checks is used for the controller."</span>
    report.p combine[<span class="hljs-property">@conf</span>.combine]
    disabled = <span class="hljs-keyword">if</span> <span class="hljs-property">@conf</span>.disabled <span class="hljs-keyword">then</span> <span class="hljs-string">"It is disabled at the moment. "</span> <span class="hljs-keyword">else</span> <span class="hljs-string">''</span>
    report.p disabled + <span class="hljs-string">"It will be called automatically every
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34"></a>
</div>
<p>{Check.formatValue @conf.interval, schema.keys.controller.entries[0].keys.interval}.&quot;</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    report.p <span class="hljs-string">"See the last results of all of this checks below!"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35"></a>
</div>
<p>contact</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    report.h2 <span class="hljs-string">"More Information"</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@conf</span>.contact
      report.p Report.b <span class="hljs-string">"Contact Persons:"</span>
<span class="hljs-function">      <span class="hljs-title">formatContact</span> = <span class="hljs-params">(name)</span> -&gt;</span>
        contact = config.get <span class="hljs-string">"/monitor/contact/<span class="hljs-subst">#{name}</span>"</span>
        <span class="hljs-keyword">if</span> Array.isArray contact
          <span class="hljs-keyword">return</span> contact.map (e) -&gt; formatContact(e)
        text = <span class="hljs-string">''</span>
        text += <span class="hljs-string">" <span class="hljs-subst">#{contact.name}</span>"</span> <span class="hljs-keyword">if</span> contact.name
        text += <span class="hljs-string">" &lt;<span class="hljs-subst">#{contact.email}</span>&gt;"</span> <span class="hljs-keyword">if</span> contact.email
        [text.trim()]
      ul = []
      <span class="hljs-keyword">for</span> group, glist <span class="hljs-keyword">of</span> <span class="hljs-property">@conf</span>.contact
        ul.push <span class="hljs-string">"__<span class="hljs-subst">#{string.ucFirst group}</span>__"</span>
        <span class="hljs-keyword">for</span> e <span class="hljs-keyword">in</span> glist
          ul = ul.concat formatContact e
      report.ul ul
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36"></a>
</div>
<p>references</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    <span class="hljs-keyword">if</span> <span class="hljs-property">@conf</span>.ref
      report.p Report.b <span class="hljs-string">"For further assistance check the following links:"</span>
      ul = []
      <span class="hljs-keyword">for</span> name, list <span class="hljs-keyword">of</span> <span class="hljs-property">@conf</span>.ref
        ul.push <span class="hljs-string">"<span class="hljs-subst">#{string.rpad name, <span class="hljs-number">15</span>}</span> "</span> + list.join <span class="hljs-string">', '</span>
      report.ul ul
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37"></a>
</div>
<p>add check results</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    report.p <span class="hljs-string">"Details of the individual sensor runs with their measurement
    values and maybe some extended analysis will follow."</span>
    report.add check.report() <span class="hljs-keyword">for</span> check <span class="hljs-keyword">in</span> <span class="hljs-property">@check</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38"></a>
</div>
<p>return result</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    report


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="helper-to-colorize-output">
  <h2>
    <a href="#helper-to-colorize-output" name="helper-to-colorize-output" class="pilcrow"></a>
Helper to colorize output
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-attribute">colorStatus</span>: <span class="hljs-function"><span class="hljs-params">(status, text)</span> -&gt;</span>
    status ?= <span class="hljs-property">@status</span>
    text ?= status
    <span class="hljs-keyword">switch</span> status
      <span class="hljs-keyword">when</span> <span class="hljs-string">'ok'</span>
        chalk.green text
      <span class="hljs-keyword">when</span> <span class="hljs-string">'warn'</span>
        chalk.yellow text
      <span class="hljs-keyword">when</span> <span class="hljs-string">'fail'</span>
        chalk.red text
      <span class="hljs-keyword">when</span> <span class="hljs-string">'disabled'</span>
        chalk.grey text
      <span class="hljs-keyword">else</span>
        text


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="export-class">
  <h2>
    <a href="#export-class" name="export-class" class="pilcrow"></a>
Export class
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-built_in">module</span>.exports =  Controller


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="calculating-controller-status">
  <h2>
    <a href="#calculating-controller-status" name="calculating-controller-status" class="pilcrow"></a>
Calculating Controller Status
  </h2>
</div>
<p>The three methods are:</p>
<ul>
<li>max - the one with the highest failure value is used</li>
<li>min - the lowest failure value is used</li>
<li>average - the average status (arithmetic round) is used</li>
</ul>
<p>With the <code>weight</code> settings on the different entries single group entries may
be rated specific not like the others. Use a number in <code>average</code> to make the
weight higher (1 is normal). Also the weight 'up' and 'down' changes the error
level for one step before using in calculation.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">calcStatus</span> = <span class="hljs-params">(combine, check, result)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42"></a>
</div>
<p>console.log combine, check, result
translate name to number</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  values =
    <span class="hljs-string">'disabled'</span>: <span class="hljs-number">0</span>
    <span class="hljs-string">'ok'</span>: <span class="hljs-number">1</span>
    <span class="hljs-string">'warn'</span>: <span class="hljs-number">2</span>
    <span class="hljs-string">'fail'</span>: <span class="hljs-number">3</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43"></a>
</div>
<p>calculate values</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">switch</span> combine
    <span class="hljs-keyword">when</span> <span class="hljs-string">'max'</span>
      status = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> num, setup <span class="hljs-keyword">of</span> check
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        val = values[result[num]]
        val-- <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-string">'down'</span> <span class="hljs-keyword">and</span> val &gt; <span class="hljs-number">0</span>
        val++ <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-string">'up'</span> <span class="hljs-keyword">and</span> val &lt; <span class="hljs-number">2</span>
        status = val <span class="hljs-keyword">if</span> val &gt; status
    <span class="hljs-keyword">when</span> <span class="hljs-string">'min'</span>
      status = <span class="hljs-number">9</span>
      num = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> num, setup <span class="hljs-keyword">of</span> check
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        val = values[result[num]]
        val-- <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-string">'down'</span> <span class="hljs-keyword">and</span> val &gt; <span class="hljs-number">0</span>
        val++ <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-string">'up'</span> <span class="hljs-keyword">and</span> val &lt; <span class="hljs-number">2</span>
        status = val <span class="hljs-keyword">if</span> val &lt; status
        num++
      status = <span class="hljs-number">0</span> <span class="hljs-keyword">unless</span> num
    <span class="hljs-keyword">when</span> <span class="hljs-string">'average'</span>
      status = <span class="hljs-number">0</span>
      num = <span class="hljs-number">0</span>
      <span class="hljs-keyword">for</span> num, setup <span class="hljs-keyword">of</span> check
        <span class="hljs-keyword">continue</span> <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-number">0</span>
        val = values[result[num]]
        val-- <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-string">'down'</span> <span class="hljs-keyword">and</span> val &gt; <span class="hljs-number">0</span>
        val++ <span class="hljs-keyword">if</span> setup.weight <span class="hljs-keyword">is</span> <span class="hljs-string">'up'</span> <span class="hljs-keyword">and</span> val &lt; <span class="hljs-number">2</span>
        status += val * setup.weight
        num += setup.weight
      status = Math.round status/num
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44"></a>
</div>
<p>translate status number to name</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  <span class="hljs-keyword">for</span> name, val <span class="hljs-keyword">of</span> values
    <span class="hljs-keyword">return</span> name <span class="hljs-keyword">if</span> status <span class="hljs-keyword">is</span> val
  <span class="hljs-keyword">return</span> <span class="hljs-string">'ok'</span>

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
