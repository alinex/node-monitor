<!DOCTYPE html>
<html>
<head>
  <title>check.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "home/alex/a3/node-monitor/src/checkcoffee", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
  <script src="../fileSearch.js"></script>
  <script src="../goToLine.js"></script>
  <link rel="stylesheet" href="../fileSearch.css" />
  <link rel="stylesheet" href="../goToLine.css" />
</head>
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io" onmouseover="lllogo.src='https://alinex.github.io/images/Alinex-200.png'" onmouseout="lllogo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="lllogo" src="https://alinex.github.io/images/Alinex-black-200.png" width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png" style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog" class="btn btn-primary"><span class="glyphicon-cog"></span> Blog</a>
  <a href="http://alinex.github.io/code.html" class="btn btn-warning"><span class="glyphicon-pencil"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h1">
        <a href="#run%20a%20check">Run a check</a>
      </div>
      <div class="heading h2">
        <a href="#node%20modules">Node Modules</a>
      </div>
      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>
      <div class="heading h2">
        <a href="#initialized%20data">Initialized Data</a>
      </div>
      <div class="heading h2">
        <a href="#controller%20class">Controller class</a>
      </div>
      <div class="heading h3">
        <a href="#create%20instance">Create instance</a>
      </div>
      <div class="heading h3">
        <a href="#initialize%20check%20and%20sensor">Initialize check and sensor</a>
      </div>
      <div class="heading h3">
        <a href="#run%20one%20sensor%20check">Run one sensor check</a>
      </div>
      <div class="heading h3">
        <a href="#really%20run%20(after%20optional%20prerun%20call)">Really run (after optional prerun call)</a>
      </div>
      <div class="heading h3">
        <a href="#create%20text%20report">create text report</a>
      </div>
      <div class="heading h2">
        <a href="#helper%20methods%20for%20sensor">Helper methods for sensor</a>
      </div>
      <div class="heading h3">
        <a href="#check%20expression%20against%20string">Check expression against string</a>
      </div>
      <div class="heading h2">
        <a href="#export%20class">Export class</a>
      </div>
      <div class="heading h3">
        <a href="#format%20a%20value%20for%20better%20human%20readable%20display">Format a value for better human readable display</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-monitor" title="Fork me on GitHub"></a><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="run%20a%20check">
  <h1>
    <a href="#run%20a%20check" name="run%20a%20check" class="pilcrow">&#182;</a>
    Run a check
  </h1>
</div>


<p>This will call the sensor and work with it. A sensor is not usable standalone
and needs a check which defines it's environment.</p>

<p>The sensor should have the following API:</p>

<ul>
<li>schema - validator compatible definition</li>
<li>meta - some meta informations</li>
<li>init() - setup of the sensor for this check</li>
<li>run() - run the sensor for the check</li>
<li>calc() - check the results</li>
</ul>

<p>The sensor will use the check instance for storing it's data and is called in
the context of the check.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre></pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="node%20modules">
  <h2>
    <a href="#node%20modules" name="node%20modules" class="pilcrow">&#182;</a>
    Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3">&#182;</a>
</div>
<p>include base modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">debug = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;debug&#39;</span><span class="p">)(</span><span class="s">&#39;monitor:check&#39;</span><span class="p">)</span>
<span class="nv">chalk = </span><span class="nx">require</span> <span class="s">&#39;chalk&#39;</span>
<span class="nv">util = </span><span class="nx">require</span> <span class="s">&#39;util&#39;</span>
<span class="nv">EventEmitter = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;events&#39;</span><span class="p">).</span><span class="nx">EventEmitter</span>
<span class="nv">vm = </span><span class="nx">require</span> <span class="s">&#39;vm&#39;</span>
<span class="nv">math = </span><span class="nx">require</span> <span class="s">&#39;mathjs&#39;</span>
<span class="nv">named = </span><span class="nx">require</span><span class="p">(</span><span class="s">&#39;named-regexp&#39;</span><span class="p">).</span><span class="nx">named</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>include alinex modules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">async = </span><span class="nx">require</span> <span class="s">&#39;alinex-async&#39;</span>
<span class="p">{</span><span class="nx">string</span><span class="p">}</span> <span class="o">=</span> <span class="nx">require</span> <span class="s">&#39;alinex-util&#39;</span>
<span class="nv">validator = </span><span class="nx">require</span> <span class="s">&#39;alinex-validator&#39;</span>
<span class="nv">Report = </span><span class="nx">require</span> <span class="s">&#39;alinex-report&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>include classes and helpers</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">storage = </span><span class="nx">require</span> <span class="s">&#39;./storage&#39;</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow">&#182;</a>
    Configuration
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">HISTORY_LENGTH = </span><span class="mi">5</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="initialized%20data">
  <h2>
    <a href="#initialized%20data" name="initialized%20data" class="pilcrow">&#182;</a>
    Initialized Data
  </h2>
</div>


<p>This will be set on init</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">monitor = </span><span class="kc">null</span>  <span class="c1"># require &#39;./index&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="controller%20class">
  <h2>
    <a href="#controller%20class" name="controller%20class" class="pilcrow">&#182;</a>
    Controller class
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="k">class</span> <span class="nx">Check</span> <span class="k">extends</span> <span class="nx">EventEmitter</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="create%20instance">
  <h3>
    <a href="#create%20instance" name="create%20instance" class="pilcrow">&#182;</a>
    Create instance
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">constructor: </span><span class="nf">(setup, @controller) -&gt;</span>
    <span class="vi">@type = </span><span class="nx">setup</span><span class="p">.</span><span class="nx">sensor</span>
    <span class="vi">@conf = </span><span class="nx">setup</span><span class="p">.</span><span class="nx">config</span> <span class="o">?</span> <span class="p">{}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10">&#182;</a>
</div>
<p>will be set after initialization</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@sensor = </span><span class="kc">null</span>
    <span class="vi">@name = </span><span class="kc">null</span>
    <span class="vi">@databaseID = </span><span class="kc">null</span>
    <span class="vi">@base = </span><span class="kc">null</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>will be filled on run</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@result = </span><span class="kc">null</span>
    <span class="vi">@status = </span><span class="s">&#39;disabled&#39;</span>
    <span class="vi">@err = </span><span class="kc">null</span>
    <span class="vi">@date = </span><span class="p">[]</span>
    <span class="vi">@values = </span><span class="p">{}</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12">&#182;</a>
</div>
<p>last results</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@history = </span><span class="p">[]</span>
    <span class="vi">@changed = </span><span class="mi">0</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="initialize%20check%20and%20sensor">
  <h3>
    <a href="#initialize%20check%20and%20sensor" name="initialize%20check%20and%20sensor" class="pilcrow">&#182;</a>
    Initialize check and sensor
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">init: </span><span class="nf">(cb) -&gt;</span>
    <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@sensor</span><span class="o">?</span>
    <span class="nx">monitor</span> <span class="o">?=</span> <span class="nx">require</span> <span class="s">&#39;./index&#39;</span>
    <span class="nx">monitor</span><span class="p">.</span><span class="nx">getSensor</span> <span class="nx">@type</span><span class="p">,</span> <span class="nf">(err, @sensor) =&gt;</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>check config</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">validator</span><span class="p">.</span><span class="nx">check</span>
        <span class="nv">name: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">@type</span><span class="si">}</span><span class="s">:</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">&quot;</span>
        <span class="nv">value: </span><span class="nx">@conf</span>
        <span class="nv">schema: </span><span class="nx">@sensor</span><span class="p">.</span><span class="nx">schema</span>
      <span class="p">,</span> <span class="nf">(err) =&gt;</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">@sensor</span><span class="p">.</span><span class="nx">init</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">@sensor</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="nx">@name</span><span class="si">}</span><span class="s"> Initialized&quot;</span>
          <span class="k">return</span> <span class="nx">cb</span><span class="p">()</span> <span class="k">unless</span> <span class="nx">@controller</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>only add database entry if run below controller</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
          <span class="nx">storage</span><span class="p">.</span><span class="nx">check</span> <span class="nx">@controller</span><span class="p">.</span><span class="nx">databaseID</span><span class="p">,</span> <span class="nx">@type</span><span class="p">,</span> <span class="nx">@name</span><span class="p">,</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">category</span>
          <span class="p">,</span> <span class="nf">(err, checkID) =&gt;</span>
            <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
            <span class="vi">@databaseID = </span><span class="nx">checkID</span>
            <span class="nx">cb</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="run%20one%20sensor%20check">
  <h3>
    <a href="#run%20one%20sensor%20check" name="run%20one%20sensor%20check" class="pilcrow">&#182;</a>
    Run one sensor check
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">run: </span><span class="nf">(cb) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>stop if already running</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">if</span> <span class="nx">@status</span> <span class="o">is</span> <span class="s">&#39;running&#39;</span>
      <span class="nx">@date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>
      <span class="vi">@err = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Skipped test because it is called again while running.&quot;</span>
      <span class="nx">@setStatus</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">cb</span> <span class="nx">@err</span><span class="p">,</span> <span class="nx">@status</span> <span class="k">unless</span> <span class="nx">@databaseID</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>store in database</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">storage</span><span class="p">.</span><span class="nx">results</span> <span class="nx">@databaseID</span><span class="p">,</span> <span class="nx">@type</span><span class="p">,</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">values</span>
      <span class="p">,</span> <span class="nx">@date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">@values</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
        <span class="nx">cb</span> <span class="nx">@err</span><span class="p">,</span> <span class="nx">@status</span>
    <span class="nx">@sensor</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="nx">@name</span><span class="si">}</span><span class="s"> start check&quot;</span>
    <span class="vi">@status = </span><span class="s">&#39;running&#39;</span>
    <span class="k">return</span> <span class="nx">@runNow</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">cb</span> <span class="k">unless</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">prerun</span><span class="o">?</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>call prerun first</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@sensor</span><span class="p">.</span><span class="nx">prerun</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nf">(@err, res) =&gt;</span> <span class="nx">@runNow</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">cb</span>



</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="really%20run%20(after%20optional%20prerun%20call)">
  <h3>
    <a href="#really%20run%20(after%20optional%20prerun%20call)" name="really%20run%20(after%20optional%20prerun%20call)" class="pilcrow">&#182;</a>
    Really run (after optional prerun call)
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">runNow: </span><span class="nf">(opt, cb) -&gt;</span>
    <span class="vi">@err = </span><span class="kc">null</span>
    <span class="vi">@date = </span><span class="p">[</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()]</span>
    <span class="vi">@values = </span><span class="p">{}</span>
    <span class="vi">@changed = </span><span class="mi">0</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>run the sensor</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">fn = </span><span class="nf">(@err, res) =&gt;</span>
      <span class="nx">@sensor</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="nx">@name</span><span class="si">}</span><span class="s"> ended check&quot;</span>
      <span class="nx">@date</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Date</span><span class="p">()</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>calculate results</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@sensor</span><span class="p">.</span><span class="nx">calc</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
        <span class="vi">@err = </span><span class="nx">err</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@err</span> <span class="o">and</span> <span class="nx">err</span>
        <span class="nx">@setStatus</span><span class="p">()</span>
        <span class="k">return</span> <span class="nx">cb</span> <span class="nx">@err</span><span class="p">,</span> <span class="nx">@status</span> <span class="k">unless</span> <span class="nx">@databaseID</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23">&#182;</a>
</div>
<p>store in database</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">storage</span><span class="p">.</span><span class="nx">results</span> <span class="nx">@databaseID</span><span class="p">,</span> <span class="nx">@type</span><span class="p">,</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">values</span>
        <span class="p">,</span> <span class="nx">@date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">@values</span><span class="p">,</span> <span class="nf">(err) =&gt;</span>
          <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span> <span class="k">if</span> <span class="nx">err</span>
          <span class="nx">cb</span> <span class="nx">@err</span><span class="p">,</span> <span class="nx">@status</span>
    <span class="k">if</span> <span class="nx">opt</span><span class="o">?</span>
      <span class="nv">started = </span><span class="nx">@date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">@sensor</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">opt</span><span class="p">,</span> <span class="nf">(err, res) =&gt;</span>
        <span class="nx">fn</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">res</span> <span class="k">if</span> <span class="nv">started = </span><span class="nx">@date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span>
      <span class="nv">started = </span><span class="nx">@date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="nx">@sensor</span><span class="p">.</span><span class="nx">run</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nf">(err, res) =&gt;</span>
        <span class="nx">fn</span> <span class="nx">err</span><span class="p">,</span> <span class="nx">res</span> <span class="k">if</span> <span class="nv">started = </span><span class="nx">@date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24">&#182;</a>
</div>
<p>set status from rules</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">setStatus: </span><span class="nf">-&gt;</span>
    <span class="nx">@calcStatus</span><span class="p">()</span>
    <span class="nx">@sensor</span><span class="p">.</span><span class="nx">debug</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="nx">@name</span><span class="si">}</span><span class="s"> result status:</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25">&#182;</a>
</div>
<p>{@status}#{if @err then ' (' + @err.message + ')' else ''}"</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="s">    for n, v of @values</span>
<span class="s">      @sensor.debug &quot;</span><span class="c1">#{chalk.grey @name} result #{n}: #{v}&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>add to history</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@history</span><span class="p">.</span><span class="nx">unshift</span>
      <span class="nv">status: </span><span class="nx">@status</span>
      <span class="nv">date: </span><span class="nx">@date</span>
      <span class="nv">values: </span><span class="nx">@values</span>
      <span class="nv">err: </span><span class="nx">@err</span>
    <span class="nx">@history</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="k">while</span> <span class="nx">@history</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="nx">HISTORY_LENGTH</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27">&#182;</a>
</div>
<p>return status</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">@status</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28">&#182;</a>
</div>
<p>calculate status</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">calcStatus: </span><span class="nf">-&gt;</span>
    <span class="k">return</span> <span class="vi">@status = </span><span class="s">&#39;fail&#39;</span> <span class="k">if</span> <span class="nx">@err</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>check for values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">unless</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">@values</span>
      <span class="vi">@err = </span><span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;no data&#39;</span>
      <span class="k">return</span> <span class="vi">@status = </span><span class="s">&#39;fail&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>calculate from values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="k">for</span> <span class="nx">status</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;fail&#39;</span><span class="p">,</span> <span class="s">&#39;warn&#39;</span><span class="p">]</span>
      <span class="k">continue</span> <span class="k">unless</span> <span class="nx">@conf</span><span class="p">[</span><span class="nx">status</span><span class="p">]</span>
      <span class="nv">rule = </span><span class="nx">@conf</span><span class="p">[</span><span class="nx">status</span><span class="p">]</span>
      <span class="nx">@sensor</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> check </span><span class="si">#{</span><span class="nx">status</span><span class="si">}</span><span class="s"> rule: </span><span class="si">#{</span><span class="nx">rule</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>replace data values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">@values</span>
        <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">value</span>
          <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span> <span class="k">in</span> <span class="nx">value</span>
            <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&quot;\\b</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">\\[</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">\\]\\b&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span>
            <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(str, name) -&gt;</span>
              <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">&#39;&quot;</span>
          <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&quot;\\b</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">\\b&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span>
          <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(str, name) -&gt;</span>
            <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">&#39;&quot;</span>
        <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
          <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">val</span> <span class="k">of</span> <span class="nx">value</span>
            <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&quot;\\b</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">\\.</span><span class="si">#{</span><span class="nx">i</span><span class="si">}</span><span class="s">\\b&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span>
            <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(str, name) -&gt;</span>
              <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">value</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">&#39;&quot;</span>
          <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&quot;\\b</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">\\b&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span>
          <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(str, name) -&gt;</span>
            <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">value</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span><span class="si">}</span><span class="s">&#39;&quot;</span>
        <span class="k">else</span>
          <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&quot;\\b</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">\\b&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span>
          <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="nf">(str, name) -&gt;</span>
            <span class="nx">value</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32">&#182;</a>
</div>
<p>replace not existing data values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">meta</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span><span class="o">?</span>
        <span class="k">for</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">meta</span><span class="p">.</span><span class="nx">values</span>
          <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&quot;\\b</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">(\\.\\w+|\\[\\d+\\])?\\b&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span>
          <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="s">&#39;null&#39;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-33" id="section-33">&#182;</a>
</div>
<p>replace percent values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\b(\d+(\.\d+)?)%/g</span><span class="p">,</span> <span class="nf">(str, value) -&gt;</span>
        <span class="nx">value</span> <span class="o">/</span> <span class="mi">100</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>replace binary values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\b(\d+(\.\d+)?)([kMGTPEYZ]?B)/g</span><span class="p">,</span> <span class="nf">(str) -&gt;</span>
        <span class="nx">math</span><span class="p">.</span><span class="nx">unit</span><span class="p">(</span><span class="nx">str</span><span class="p">).</span><span class="nx">toNumber</span><span class="p">(</span><span class="s">&#39;B&#39;</span><span class="p">)</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>replace interval values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="sr">/\b(\d+(\.\d+)?)(ms|s|m|h|d)/g</span><span class="p">,</span> <span class="nf">(str) -&gt;</span>
        <span class="nx">number</span><span class="p">.</span><span class="nx">parseMSeconds</span> <span class="nx">str</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>replace operators</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="p">{</span><span class="o">and:</span> <span class="s">&#39;&amp;&amp;&#39;</span><span class="p">,</span> <span class="o">or:</span> <span class="s">&#39;||&#39;</span><span class="p">,</span> <span class="o">is:</span> <span class="s">&#39;==&#39;</span><span class="p">,</span> <span class="o">isnt:</span> <span class="s">&#39;!=&#39;</span><span class="p">,</span> <span class="o">not:</span> <span class="s">&#39;!&#39;</span><span class="p">}</span>
        <span class="nv">re = </span><span class="k">new</span> <span class="nb">RegExp</span> <span class="s">&quot;\\b</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">\\b&quot;</span><span class="p">,</span> <span class="s">&#39;g&#39;</span>
        <span class="nv">rule = </span><span class="nx">rule</span><span class="p">.</span><span class="nx">replace</span> <span class="nx">re</span><span class="p">,</span> <span class="nx">value</span>
      <span class="nx">@sensor</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> optimized: </span><span class="si">#{</span><span class="nx">rule</span><span class="si">}</span><span class="s">&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>run the code in sandbox</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">sandbox = </span><span class="p">{}</span>
      <span class="nx">vm</span><span class="p">.</span><span class="nx">runInNewContext</span> <span class="s">&quot;result = </span><span class="si">#{</span><span class="nx">rule</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">sandbox</span><span class="p">,</span> <span class="p">{</span><span class="nv">filename: </span><span class="s">&#39;monitor-sensor-rule.vm&#39;</span><span class="p">}</span>
      <span class="nx">@sensor</span><span class="p">.</span><span class="nx">debug</span> <span class="nx">chalk</span><span class="p">.</span><span class="nx">grey</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s"> rule result: </span><span class="si">#{</span><span class="nx">status</span><span class="si">}</span><span class="s"> = </span><span class="si">#{</span><span class="nx">sandbox</span><span class="p">.</span><span class="nx">result</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">if</span> <span class="nx">sandbox</span><span class="p">.</span><span class="nx">result</span>
        <span class="vi">@err = </span><span class="k">new</span> <span class="nb">Error</span> <span class="nx">@conf</span><span class="p">[</span><span class="nx">status</span><span class="p">]</span>
        <span class="k">return</span> <span class="vi">@status = </span><span class="nx">status</span>
    <span class="vi">@status = </span><span class="s">&#39;ok&#39;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="create%20text%20report">
  <h3>
    <a href="#create%20text%20report" name="create%20text%20report" class="pilcrow">&#182;</a>
    create text report
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">report: </span><span class="nf">(cb) -&gt;</span>
    <span class="nv">last = </span><span class="nx">@history</span><span class="p">[</span><span class="nx">@history</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
    <span class="nv">report = </span><span class="k">new</span> <span class="nx">Report</span><span class="p">()</span>
    <span class="nx">report</span><span class="p">.</span><span class="nx">h2</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">title</span><span class="si">}</span><span class="s"> </span><span class="si">#{</span><span class="nx">@name</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">report</span><span class="p">.</span><span class="nx">p</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">description</span>
    <span class="nx">report</span><span class="p">.</span><span class="nx">p</span> <span class="s">&quot;Last check results from </span><span class="si">#{</span><span class="nx">last</span><span class="p">.</span><span class="nx">date</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s"> are:&quot;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>table with max. last 3 values</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">data = </span><span class="p">[]</span>
    <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">conf</span> <span class="k">of</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">values</span>
      <span class="k">continue</span> <span class="k">unless</span> <span class="nv">value = </span><span class="nx">last</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span> <span class="o">and</span> <span class="o">not</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">value</span>
        <span class="k">for</span> <span class="nx">k</span> <span class="k">of</span> <span class="nx">value</span>
          <span class="nv">row = </span><span class="p">[</span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">conf</span><span class="p">.</span><span class="nx">title</span> <span class="o">?</span> <span class="nx">key</span><span class="si">}</span><span class="s">.</span><span class="si">#{</span><span class="nx">k</span><span class="si">}</span><span class="s">&quot;</span><span class="p">]</span>
          <span class="nx">row</span><span class="p">.</span><span class="nx">push</span> <span class="nx">formatValue</span> <span class="nx">e</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="nx">k</span><span class="p">],</span> <span class="nx">conf</span> <span class="k">for</span> <span class="nx">e</span> <span class="k">in</span> <span class="nx">@history</span><span class="p">[..</span><span class="mi">2</span><span class="p">]</span>
          <span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="nx">row</span>
      <span class="k">else</span>
        <span class="nv">row = </span><span class="p">[</span><span class="nx">conf</span><span class="p">.</span><span class="nx">title</span> <span class="o">?</span> <span class="nx">key</span><span class="p">]</span>
        <span class="nx">row</span><span class="p">.</span><span class="nx">push</span> <span class="nx">formatValue</span> <span class="nx">e</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">key</span><span class="p">],</span> <span class="nx">conf</span> <span class="k">for</span> <span class="nx">e</span> <span class="k">in</span> <span class="nx">@history</span><span class="p">[..</span><span class="mi">2</span><span class="p">]</span>
        <span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="nx">row</span>
    <span class="nv">col =</span>
      <span class="mi">0</span><span class="o">:</span>
        <span class="nv">title: </span><span class="s">&#39;LABEL&#39;</span>
      <span class="mi">1</span><span class="o">:</span>
        <span class="nv">title: </span><span class="s">&#39;VALUE&#39;</span>
        <span class="nv">align: </span><span class="s">&#39;right&#39;</span>
    <span class="k">if</span> <span class="nx">@history</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="nx">e</span><span class="p">,</span> <span class="nx">num</span> <span class="k">in</span> <span class="nx">@history</span><span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="mi">2</span><span class="p">]</span>
        <span class="nx">col</span><span class="p">[</span><span class="nx">num</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="nv">title: </span><span class="s">&#39;PREVIOUS&#39;</span><span class="p">,</span> <span class="nv">align: </span><span class="s">&#39;right&#39;</span><span class="p">}</span>
    <span class="nx">report</span><span class="p">.</span><span class="nx">table</span> <span class="nx">data</span><span class="p">,</span> <span class="nx">col</span>
    <span class="k">if</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hint</span>
      <span class="nx">report</span><span class="p">.</span><span class="nx">quote</span> <span class="nx">@sensor</span><span class="p">.</span><span class="nx">meta</span><span class="p">.</span><span class="nx">hint</span>
    <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">report</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="helper%20methods%20for%20sensor">
  <h2>
    <a href="#helper%20methods%20for%20sensor" name="helper%20methods%20for%20sensor" class="pilcrow">&#182;</a>
    Helper methods for sensor
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="check%20expression%20against%20string">
  <h3>
    <a href="#check%20expression%20against%20string" name="check%20expression%20against%20string" class="pilcrow">&#182;</a>
    Check expression against string
  </h3>
</div>


<p>It will will try to match the given expression once and return the matched
groups or false if not matched. The groups are an array with the full match as
first element or in case of named regexp an object with key 'match' containing
the full match.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">match: </span><span class="nf">(text, re) -&gt;</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="nx">re</span><span class="o">?</span>
    <span class="k">unless</span> <span class="nx">re</span> <span class="k">instanceof</span> <span class="nb">RegExp</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nb">Boolean</span> <span class="o">~</span><span class="nx">text</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">re</span> <span class="k">then</span> <span class="p">[</span><span class="nx">re</span><span class="p">]</span> <span class="k">else</span> <span class="kc">false</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>it's an regular expression</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">useNamed = </span><span class="o">~</span><span class="nx">re</span><span class="p">.</span><span class="nx">toString</span><span class="p">().</span><span class="nx">indexOf</span> <span class="s">&#39;(:&lt;&#39;</span>
    <span class="nv">re = </span><span class="nx">named</span> <span class="nx">re</span> <span class="k">if</span> <span class="nx">useNamed</span>
    <span class="k">return</span> <span class="kc">false</span> <span class="k">unless</span> <span class="nv">match = </span><span class="nx">re</span><span class="p">.</span><span class="nx">exec</span> <span class="nx">text</span>
    <span class="k">if</span> <span class="nx">useNamed</span>
      <span class="nv">matches = </span><span class="p">{}</span>
      <span class="nx">matches</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">capture</span> <span class="nx">name</span> <span class="k">for</span> <span class="nx">name</span> <span class="k">of</span> <span class="nx">match</span><span class="p">.</span><span class="nx">captures</span>
    <span class="k">else</span>
      <span class="nv">matches = </span><span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="nx">match</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">matches</span>




</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="export%20class">
  <h2>
    <a href="#export%20class" name="export%20class" class="pilcrow">&#182;</a>
    Export class
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>

<span class="nv">module.exports = </span> <span class="nx">Check</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="format%20a%20value%20for%20better%20human%20readable%20display">
  <h3>
    <a href="#format%20a%20value%20for%20better%20human%20readable%20display" name="format%20a%20value%20for%20better%20human%20readable%20display" class="pilcrow">&#182;</a>
    Format a value for better human readable display
  </h3>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
<span class="nv">formatValue = </span><span class="nf">(value, config) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>format with autodetect</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">unless</span> <span class="nx">config</span>
    <span class="k">return</span> <span class="k">switch</span>
      <span class="k">when</span> <span class="k">typeof</span> <span class="nx">value</span> <span class="o">is</span> <span class="s">&#39;number&#39;</span>
        <span class="nv">parts = </span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">value</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">).</span><span class="nx">toString</span><span class="p">().</span><span class="nx">split</span> <span class="s">&#39;.&#39;</span>
        <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">replace</span> <span class="sr">/\B(?=(\d{3})+(?!\d))/g</span><span class="p">,</span> <span class="s">&quot;,&quot;</span>
        <span class="nx">parts</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;.&#39;</span>
      <span class="k">else</span>
        <span class="nx">value</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>format using config setting</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="k">switch</span> <span class="nx">config</span><span class="p">.</span><span class="nx">type</span>
    <span class="k">when</span> <span class="s">&#39;percent&#39;</span>
      <span class="nx">math</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="nx">value</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39; %&#39;</span>
    <span class="k">when</span> <span class="s">&#39;byte&#39;</span>
      <span class="nv">byte = </span><span class="nx">math</span><span class="p">.</span><span class="nx">unit</span> <span class="nx">value</span><span class="p">,</span> <span class="s">&#39;B&#39;</span>
      <span class="nx">byte</span><span class="p">.</span><span class="nx">format</span> <span class="mi">3</span>
    <span class="k">when</span> <span class="s">&#39;interval&#39;</span>
      <span class="nv">long =</span>
        <span class="nv">d: </span><span class="s">&#39;day&#39;</span>
        <span class="nv">m: </span><span class="s">&#39;minute&#39;</span>
      <span class="nv">unit = </span><span class="nx">long</span><span class="p">[</span><span class="nx">config</span><span class="p">.</span><span class="nx">unit</span><span class="p">]</span> <span class="o">?</span> <span class="nx">config</span><span class="p">.</span><span class="nx">unit</span>
      <span class="nv">interval = </span><span class="nx">math</span><span class="p">.</span><span class="nx">unit</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">unit</span>
      <span class="nv">interval = </span><span class="nx">interval</span><span class="p">.</span><span class="nx">to</span> <span class="s">&#39;m&#39;</span> <span class="k">if</span> <span class="nx">interval</span><span class="p">.</span><span class="nx">toNumber</span><span class="p">(</span><span class="s">&#39;s&#39;</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">120</span>
      <span class="nx">interval</span><span class="p">.</span><span class="nx">format</span> <span class="mi">2</span>
    <span class="k">when</span> <span class="s">&#39;float&#39;</span><span class="p">,</span> <span class="s">&#39;integer&#39;</span>
      <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="nx">unit</span><span class="o">?</span>
        <span class="nx">math</span><span class="p">.</span><span class="nx">unit</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="nx">config</span><span class="p">.</span><span class="nx">unit</span><span class="p">).</span><span class="nx">format</span> <span class="mi">3</span>
      <span class="k">else</span>
        <span class="nx">math</span><span class="p">.</span><span class="nx">format</span> <span class="nx">value</span><span class="p">,</span> <span class="mi">3</span>
    <span class="k">when</span> <span class="s">&#39;array&#39;</span>
      <span class="nv">val = </span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">9</span><span class="p">].</span><span class="nx">join</span> <span class="s">&#39;, &#39;</span>
      <span class="nx">val</span> <span class="o">+=</span> <span class="s">&#39;...&#39;</span> <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span>
      <span class="nx">val</span>
    <span class="k">when</span> <span class="s">&#39;object&#39;</span>
      <span class="k">switch</span> <span class="k">typeof</span> <span class="nx">value</span>
        <span class="k">when</span> <span class="s">&#39;string&#39;</span><span class="p">,</span> <span class="s">&#39;number&#39;</span>
          <span class="nx">value</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">value</span>
            <span class="nv">val = </span><span class="nx">value</span><span class="p">[</span><span class="mi">0</span><span class="p">..</span><span class="mi">9</span><span class="p">].</span><span class="nx">join</span> <span class="s">&#39;, &#39;</span>
            <span class="nx">val</span> <span class="o">+=</span> <span class="s">&#39;...&#39;</span> <span class="k">if</span> <span class="nx">value</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">10</span>
            <span class="nx">val</span>
          <span class="k">else</span>
            <span class="nx">util</span><span class="p">.</span><span class="nx">inspect</span><span class="p">(</span><span class="nx">value</span><span class="p">).</span><span class="nx">replace</span> <span class="sr">/\n/g</span><span class="p">,</span> <span class="s">&#39; &#39;</span>
    <span class="k">else</span>
      <span class="nv">val = </span><span class="nx">value</span>
      <span class="nx">val</span> <span class="o">+=</span> <span class="s">&quot; </span><span class="si">#{</span><span class="nx">config</span><span class="p">.</span><span class="nx">unit</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">and</span> <span class="nx">config</span><span class="p">.</span><span class="nx">unit</span>
      <span class="nx">val</span>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
