<!DOCTYPE html>
<html>
<head>
  <title>storage.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../";
    var thisFile = "home/alex/github/node-monitor/src/storage.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>

<meta name="viewport" content="width=device-width, initial-scale=1.0" /></head
<body>
  <nav>
<div class="logo"><a href="http://alinex.github.io"
  onmouseover="logo.src='https://alinex.github.io/images/Alinex-200.png'"
  onmouseout="logo.src='https://alinex.github.io/images/Alinex-black-200.png'">
  <img name="logo" src="https://alinex.github.io/images/Alinex-black-200.png"
    width="150" title="Alinex Universe Homepage" />
  </a>
  <img src="http://alinex.github.io/images/Alinex-200.png"
    style="display:none" alt="preloading" />
</div>
<div class="links">
  <a href="http://alinex.github.io/blog"
    class="btn btn-primary"><span class="glyphicon-pencil"></span> Blog</a>
  <a href="http://alinex.github.io/develop"
    class="btn btn-primary"><span class="glyphicon-book"></span> Develop</a>
  <a href="http://alinex.github.io/code.html"
    class="btn btn-warning"><span class="glyphicon-cog"></span> Code</a>
</div>
</nav><div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#storage-management">Storage Management</a>
      </div>

      <div class="heading h2">
        <a href="#node-modules">Node Modules</a>
      </div>

      <div class="heading h2">
        <a href="#configuration">Configuration</a>
      </div>

      <div class="heading h2">
        <a href="#initialized-data">Initialized Data</a>
      </div>

      <div class="heading h2">
        <a href="#initialize-database">Initialize database</a>
      </div>

      <div class="heading h2">
        <a href="#drop-database">Drop database</a>
      </div>

      <div class="heading h2">
        <a href="#create-database-structure">Create database structure</a>
      </div>

      <div class="heading h2">
        <a href="#get-or-register-controller">Get or register controller</a>
      </div>

      <div class="heading h2">
        <a href="#get-or-register-check">Get or register check</a>
      </div>

      <div class="heading h2">
        <a href="#add-results">Add results</a>
      </div>

      <div class="heading h2">
        <a href="#add-status-on-change">Add status on change</a>
      </div>

      <div class="heading h2">
        <a href="#cleanup-old-data">Cleanup old data</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container" tabindex="0"><a id="fork" href="https://github.com/alinex/node-monitor" title="Fork me on GitHub"></a>
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="storage-management">
  <h1>
    <a href="#storage-management" name="storage-management" class="pilcrow"></a>
Storage Management
  </h1>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="node-modules">
  <h2>
    <a href="#node-modules" name="node-modules" class="pilcrow"></a>
Node Modules
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>include base modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'monitor:storage'</span>)
chalk = <span class="hljs-built_in">require</span> <span class="hljs-string">'chalk'</span>
moment = <span class="hljs-built_in">require</span> <span class="hljs-string">'moment'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>include alinex modules</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">config = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-config'</span>
async = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-async'</span>
database = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-database'</span>
{string} = <span class="hljs-built_in">require</span> <span class="hljs-string">'alinex-util'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>include classes and helpers</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="configuration">
  <h2>
    <a href="#configuration" name="configuration" class="pilcrow"></a>
Configuration
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">cleanupInterval =
  <span class="hljs-attribute">minute</span>: <span class="hljs-number">1800</span>*<span class="hljs-number">1000</span> <span class="hljs-comment"># every half hour</span>
  <span class="hljs-attribute">hour</span>: <span class="hljs-number">3600</span>*<span class="hljs-number">1000</span> <span class="hljs-comment"># every hour</span>
  <span class="hljs-attribute">day</span>: <span class="hljs-number">24</span>*<span class="hljs-number">3600</span>*<span class="hljs-number">1000</span> <span class="hljs-comment"># every day</span>
  <span class="hljs-attribute">week</span>: <span class="hljs-number">7</span>*<span class="hljs-number">24</span>*<span class="hljs-number">3600</span>*<span class="hljs-number">1000</span> <span class="hljs-comment"># every week</span>
  <span class="hljs-attribute">month</span>: <span class="hljs-number">24</span>*<span class="hljs-number">24</span>*<span class="hljs-number">3600</span>*<span class="hljs-number">1000</span> <span class="hljs-comment"># every 24 days (maximum for setTimeout)</span>
  <span class="hljs-attribute">other</span>: <span class="hljs-number">7</span>*<span class="hljs-number">24</span>*<span class="hljs-number">3600</span>*<span class="hljs-number">1000</span> <span class="hljs-comment"># every week</span>


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialized-data">
  <h2>
    <a href="#initialized-data" name="initialized-data" class="pilcrow"></a>
Initialized Data
  </h2>
</div>
<p>This will be set on init</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">monitor = <span class="hljs-literal">null</span>  <span class="hljs-comment"># require './index'</span>
conf = <span class="hljs-literal">null</span>
mode = {}


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="initialize-database">
  <h2>
    <a href="#initialize-database" name="initialize-database" class="pilcrow"></a>
Initialize database
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.init = <span class="hljs-function"><span class="hljs-params">(setup, cb)</span> -&gt;</span>
  mode = setup
  monitor ?= <span class="hljs-built_in">require</span> <span class="hljs-string">'./index'</span>
  conf ?= config.get <span class="hljs-string">'/monitor'</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.storage?.database? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mode.<span class="hljs-keyword">try</span>
  debug <span class="hljs-string">"Initialize database store..."</span>
  database.instance conf.storage.database, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    drop conf, db, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      create conf, db, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        cleanup interval <span class="hljs-keyword">for</span> interval <span class="hljs-keyword">of</span> cleanupInterval
        cb err


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="drop-database">
  <h2>
    <a href="#drop-database" name="drop-database" class="pilcrow"></a>
Drop database
  </h2>
</div>
<p>This should not be enabled in productive system.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">drop</span> = <span class="hljs-params">(conf, db, cb)</span> -&gt;</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-comment"># disable function</span>
  async.eachSeries [
    <span class="hljs-string">"DROP SCHEMA public CASCADE"</span>
    <span class="hljs-string">"CREATE SCHEMA public"</span>
  ], <span class="hljs-function"><span class="hljs-params">(sql, cb)</span> -&gt;</span>
    db.exec sql, cb
  , cb


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="create-database-structure">
  <h2>
    <a href="#create-database-structure" name="create-database-structure" class="pilcrow"></a>
Create database structure
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">create</span> = <span class="hljs-params">(conf, db, cb)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>check if tables are installed</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  prefix = conf.storage.prefix
  queries =
    <span class="hljs-attribute">controller</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      CREATE TABLE IF NOT EXISTS <span class="hljs-subst">#{prefix}</span>controller (
        controller_id SERIAL PRIMARY KEY,
        name VARCHAR(32) UNIQUE NOT NULL
      )
      """</span>, cb
    <span class="hljs-attribute">check</span>: [<span class="hljs-string">'controller'</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      CREATE TABLE IF NOT EXISTS <span class="hljs-subst">#{prefix}</span>check (
        check_id SERIAL PRIMARY KEY,
        controller_id INTEGER REFERENCES <span class="hljs-subst">#{prefix}</span>controller ON DELETE CASCADE,
        sensor VARCHAR(16) NOT NULL,
        name VARCHAR(120),
        category VARCHAR(8) NOT NULL,
        mapping TEXT
      )
      """</span>, cb]
    <span class="hljs-attribute">idx_check</span>: [<span class="hljs-string">'check'</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      DO $$
      BEGIN
        IF NOT EXISTS (
            SELECT 1
            FROM   pg_class c
            JOIN   pg_namespace n ON n.oid = c.relnamespace
            WHERE  c.relname = 'idx_<span class="hljs-subst">#{prefix}</span>check'
            AND    n.nspname = 'public'
            ) THEN
            CREATE UNIQUE INDEX idx_<span class="hljs-subst">#{prefix}</span>check ON <span class="hljs-subst">#{prefix}</span>check (controller_id, sensor, name);
        END IF;
      END$$;
      """</span>, cb]
    <span class="hljs-attribute">intervalType</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      DO $$
      BEGIN
          IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = '<span class="hljs-subst">#{prefix}</span>interval') THEN
            CREATE TYPE <span class="hljs-subst">#{prefix}</span>interval AS ENUM ('minute', 'hour', 'day', 'week', 'month');
          END IF;
      END$$;
      """</span>, cb
    <span class="hljs-attribute">statusType</span>: <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      DO $$
      BEGIN
          IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = '<span class="hljs-subst">#{prefix}</span>status') THEN
            CREATE TYPE <span class="hljs-subst">#{prefix}</span>status AS ENUM ('ok', 'warn', 'fail');
          END IF;
      END$$;
      """</span>, cb
    <span class="hljs-attribute">statusSensor</span>: [<span class="hljs-string">'statusType'</span>, <span class="hljs-string">'check'</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      CREATE TABLE IF NOT EXISTS <span class="hljs-subst">#{prefix}</span>status_check (
        check_id INTEGER REFERENCES <span class="hljs-subst">#{prefix}</span>check ON DELETE CASCADE,
        change TIMESTAMP WITH TIME ZONE,
        status <span class="hljs-subst">#{prefix}</span>status NOT NULL,
        comment VARCHAR(120)
      )
      """</span>, cb]
    <span class="hljs-attribute">statusController</span>: [<span class="hljs-string">'statusType'</span>, <span class="hljs-string">'controller'</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      CREATE TABLE IF NOT EXISTS <span class="hljs-subst">#{prefix}</span>status_controller (
        controller_id INTEGER REFERENCES <span class="hljs-subst">#{prefix}</span>controller ON DELETE CASCADE,
        change TIMESTAMP WITH TIME ZONE,
        status <span class="hljs-subst">#{prefix}</span>status NOT NULL
      )
      """</span>, cb]
    <span class="hljs-attribute">report</span>: [<span class="hljs-string">'controller'</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec <span class="hljs-string">"""
      CREATE TABLE IF NOT EXISTS <span class="hljs-subst">#{prefix}</span>report (
        report_id SERIAL PRIMARY KEY,
        controller_id INTEGER REFERENCES <span class="hljs-subst">#{prefix}</span>controller ON DELETE CASCADE,
        date TIMESTAMP WITH TIME ZONE,
        report TEXT NOT NULL
      )
      """</span>, cb]
  monitor = <span class="hljs-built_in">require</span> <span class="hljs-string">'./index'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>add sensor tables</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  async.each monitor.listSensor(), <span class="hljs-function"><span class="hljs-params">(name, cb)</span> -&gt;</span>
    monitor.getSensor name, <span class="hljs-function"><span class="hljs-params">(err, sensor)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      sql = <span class="hljs-string">"""
        CREATE TABLE IF NOT EXISTS <span class="hljs-subst">#{prefix}</span>sensor_<span class="hljs-subst">#{name}</span> (
          check_id INTEGER REFERENCES <span class="hljs-subst">#{prefix}</span>check ON DELETE CASCADE,
          interval <span class="hljs-subst">#{prefix}</span>interval NOT NULL,
          period TIMESTAMP WITH TIME ZONE,
          _c INTEGER NOT NULL
        """</span>
      <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> sensor.meta.values
        type = <span class="hljs-keyword">switch</span> v.type
          <span class="hljs-keyword">when</span> <span class="hljs-string">'integer'</span>, <span class="hljs-string">'byte'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'BIGINT'</span>
          <span class="hljs-keyword">when</span> <span class="hljs-string">'float'</span>, <span class="hljs-string">'percent'</span>, <span class="hljs-string">'interval'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'FLOAT'</span>
          <span class="hljs-keyword">when</span> <span class="hljs-string">'date'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'TIMESTAMP WITH TIME ZONE'</span>
          <span class="hljs-keyword">else</span> <span class="hljs-string">'VARCHAR(100)'</span>
        sql += <span class="hljs-string">", \"<span class="hljs-subst">#{k.toLowerCase()}</span>\" <span class="hljs-subst">#{type}</span>"</span>
      sql += <span class="hljs-string">")"</span>
      queries[<span class="hljs-string">"sensor_<span class="hljs-subst">#{name}</span>"</span>] = [<span class="hljs-string">'intervalType'</span>, <span class="hljs-string">'check'</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec sql, cb]
      cb()
  , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
    <span class="hljs-built_in">console</span>.error chalk.red err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>add actor tables</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    async.each monitor.listActor(), <span class="hljs-function"><span class="hljs-params">(name, cb)</span> -&gt;</span>
      monitor.getActor name, <span class="hljs-function"><span class="hljs-params">(err, actor)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
        sql = <span class="hljs-string">"""
          CREATE TABLE IF NOT EXISTS <span class="hljs-subst">#{prefix}</span>actor_<span class="hljs-subst">#{name}</span> (
            controller_id INTEGER REFERENCES <span class="hljs-subst">#{prefix}</span>controller ON DELETE CASCADE,
            runAt TIMESTAMP WITH TIME ZONE
          """</span>
        <span class="hljs-keyword">for</span> k, v <span class="hljs-keyword">of</span> actor.meta.values
          type = <span class="hljs-keyword">switch</span> v.type
            <span class="hljs-keyword">when</span> <span class="hljs-string">'integer'</span>, <span class="hljs-string">'byte'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'BIGINT'</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'float'</span>, <span class="hljs-string">'percent'</span>, <span class="hljs-string">'interval'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'FLOAT'</span>
            <span class="hljs-keyword">when</span> <span class="hljs-string">'date'</span> <span class="hljs-keyword">then</span> <span class="hljs-string">'TIMESTAMP WITH TIME ZONE'</span>
            <span class="hljs-keyword">else</span> <span class="hljs-string">'VARCHAR(100)'</span>
          sql += <span class="hljs-string">", \"<span class="hljs-subst">#{k.toLowerCase()}</span>\" <span class="hljs-subst">#{type}</span>"</span>
        sql += <span class="hljs-string">")"</span>
        queries[<span class="hljs-string">"actor_<span class="hljs-subst">#{name}</span>"</span>] = [<span class="hljs-string">'controller'</span>, <span class="hljs-function"><span class="hljs-params">(cb)</span> -&gt;</span> db.exec sql, cb]
        cb()
    , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
      <span class="hljs-built_in">console</span>.error chalk.red err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>run all sql queries</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      async.auto queries, db.conf.pool?.limit ? <span class="hljs-number">10</span>, cb


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-or-register-controller">
  <h2>
    <a href="#get-or-register-controller" name="get-or-register-controller" class="pilcrow"></a>
Get or register controller
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.controller = <span class="hljs-function"><span class="hljs-params">(name, cb)</span> -&gt;</span>
  conf ?= config.get <span class="hljs-string">'/monitor'</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.storage?.database? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mode.<span class="hljs-keyword">try</span>
  prefix = conf.storage.prefix
  database.instance conf.storage.database, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    db.value <span class="hljs-string">"""
      SELECT controller_id FROM <span class="hljs-subst">#{prefix}</span>controller WHERE name=$1
      """</span>, name, <span class="hljs-function"><span class="hljs-params">(err, value)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err, value <span class="hljs-keyword">if</span> err <span class="hljs-keyword">or</span> value
      debug <span class="hljs-string">"register controller <span class="hljs-subst">#{name}</span>"</span>
      db.exec <span class="hljs-string">"""
        INSERT INTO <span class="hljs-subst">#{prefix}</span>controller (name) VALUES ($1) RETURNING controller_id
        """</span>, name, <span class="hljs-function"><span class="hljs-params">(err, num, id)</span> -&gt;</span>
        cb err, id


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="get-or-register-check">
  <h2>
    <a href="#get-or-register-check" name="get-or-register-check" class="pilcrow"></a>
Get or register check
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.check = <span class="hljs-function"><span class="hljs-params">(controller, sensor, name, meta, cb)</span> -&gt;</span>
  conf ?= config.get <span class="hljs-string">'/monitor'</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.storage?.database? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mode.<span class="hljs-keyword">try</span>
  prefix = conf.storage.prefix
  database.instance conf.storage.database, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    db.value <span class="hljs-string">"""
      SELECT check_id FROM <span class="hljs-subst">#{prefix}</span>check WHERE controller_id=$1 AND sensor=$2 AND name=$3
      """</span>, [controller, sensor, name], <span class="hljs-function"><span class="hljs-params">(err, value)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err, value <span class="hljs-keyword">if</span> err <span class="hljs-keyword">or</span> value
      debug <span class="hljs-string">"register check <span class="hljs-subst">#{sensor}</span>:<span class="hljs-subst">#{name}</span> for controller_id <span class="hljs-subst">#{controller}</span>"</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>add mapping information</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      <span class="hljs-keyword">if</span> meta.mapping?
        mapping = {}
        <span class="hljs-keyword">for</span> key, set <span class="hljs-keyword">of</span> meta.mapping
          mapping[set.storage] =
            <span class="hljs-attribute">name</span>: key
          mapping[set.storage].title = set.title <span class="hljs-keyword">if</span> set.title
          mapping[set.storage].type = set.type <span class="hljs-keyword">if</span> set.type
        mapping = JSON.stringify mapping
      db.exec <span class="hljs-string">"""
        INSERT INTO <span class="hljs-subst">#{prefix}</span>check
        (controller_id, sensor, name, category, mapping) VALUES (?, ?, ?, ?, ?)
        RETURNING check_id
        """</span>, [controller, sensor, name, meta.category, mapping ? <span class="hljs-literal">null</span>], <span class="hljs-function"><span class="hljs-params">(err, num, id)</span> -&gt;</span>
        cb err, id


valueTypes = [<span class="hljs-string">'integer'</span>, <span class="hljs-string">'float'</span>, <span class="hljs-string">'interval'</span>, <span class="hljs-string">'byte'</span>, <span class="hljs-string">'percent'</span>]

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="add-results">
  <h2>
    <a href="#add-results" name="add-results" class="pilcrow"></a>
Add results
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.results = <span class="hljs-function"><span class="hljs-params">(checkID, sensor, meta, date, value, cb)</span> -&gt;</span>
  conf ?= config.get <span class="hljs-string">'/monitor'</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.storage?.database? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mode.<span class="hljs-keyword">try</span>
  prefix = conf.storage.prefix
  database.instance conf.storage.database, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
    async.each [<span class="hljs-string">'minute'</span>, <span class="hljs-string">'hour'</span>, <span class="hljs-string">'day'</span>, <span class="hljs-string">'week'</span>, <span class="hljs-string">'month'</span>], <span class="hljs-function"><span class="hljs-params">(interval, cb)</span> -&gt;</span> <span class="hljs-comment"># 'quarter', 'year'</span>
      period = moment(date).startOf(interval).toDate()
      db.value <span class="hljs-string">"""
        SELECT COUNT(*)::int FROM <span class="hljs-subst">#{prefix}</span>sensor_<span class="hljs-subst">#{sensor}</span>
        WHERE check_id=$1 AND interval=$2 AND period=$3
        """</span>, [checkID, interval, period], <span class="hljs-function"><span class="hljs-params">(err, exists)</span> -&gt;</span>
        <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>insert</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-keyword">unless</span> exists
          debug <span class="hljs-string">"add results to check <span class="hljs-subst">#{checkID}</span> (<span class="hljs-subst">#{sensor}</span>) for <span class="hljs-subst">#{interval}</span>"</span>
          db.exec <span class="hljs-string">"""
            INSERT INTO <span class="hljs-subst">#{prefix}</span>sensor_<span class="hljs-subst">#{sensor}</span>
            (check_id, interval, period, _c, "<span class="hljs-subst">#{Object.keys(value).join(<span class="hljs-string">'", "'</span>).toLowerCase()}</span>")
            VALUES (?, ?, ?, 1<span class="hljs-subst">#{string.repeat <span class="hljs-string">', ?'</span>, Object.keys(value).length}</span>)
            """</span>
          , [checkID, interval, period].concat(Object.keys(value).map (k) -&gt; value[k])
          , <span class="hljs-function"><span class="hljs-params">(err, num, id)</span> -&gt;</span>
            cb err, id
          <span class="hljs-keyword">return</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>update</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        debug <span class="hljs-string">"update results to check <span class="hljs-subst">#{checkID}</span> (<span class="hljs-subst">#{sensor}</span>) for <span class="hljs-subst">#{interval}</span>"</span>
        set = <span class="hljs-string">"SET _c = _c+1, "</span> + Object.keys(value).map (k) -&gt;
          <span class="hljs-keyword">if</span> meta[k].type <span class="hljs-keyword">in</span> valueTypes
            <span class="hljs-string">"\"<span class="hljs-subst">#{k}</span>\" = (\"<span class="hljs-subst">#{k}</span>\" * _c  + ?) / (_c+1)"</span>
          <span class="hljs-keyword">else</span>
            <span class="hljs-string">"\"<span class="hljs-subst">#{k}</span>\" = ?"</span>
        .join <span class="hljs-string">', '</span>
        .toLowerCase()
        db.exec <span class="hljs-string">"""
          UPDATE <span class="hljs-subst">#{prefix}</span>sensor_<span class="hljs-subst">#{sensor}</span>
</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>{set}</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">          WHERE check_id=? AND interval=? AND period=?
          <span class="hljs-string">"""
        , (Object.keys(value).map (k) -&gt; value[k]).concat([checkID, interval, period])
        , (err, num, id) -&gt;
          cb err, id
    , cb

exports.action = (controllerID, actor, meta, date, value, cb) -&gt;
  conf ?= config.get '/monitor'
  return cb() unless conf.storage?.database? and not mode.try
  prefix = conf.storage.prefix
  database.instance conf.storage.database, (err, db) -&gt;
    return cb err if err
    db.exec """</span>
      INSERT INTO <span class="hljs-comment">#{prefix}actor_#{actor}</span>
      (controller_id, runAt, <span class="hljs-string">"<span class="hljs-subst">#{Object.keys(value).join(<span class="hljs-string">'", "'</span>).toLowerCase()}</span>"</span>)
      VALUES (?, ?<span class="hljs-comment">#{string.repeat ', ?', Object.keys(value).length})</span>
      <span class="hljs-string">"""
    , [controllerID, date].concat(Object.keys(value).map (k) -&gt; value[k])
    , (err, num, id) -&gt;
      cb err, id


</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="add-status-on-change">
  <h2>
    <a href="#add-status-on-change" name="add-status-on-change" class="pilcrow"></a>
Add status on change
  </h2>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">exports.statusCheck = <span class="hljs-function"><span class="hljs-params">(checkID, date, status, comment, cb)</span> -&gt;</span>
  conf ?= config.get <span class="hljs-string">'/monitor'</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.storage?.database? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mode.<span class="hljs-keyword">try</span>
  prefix = conf.storage.prefix
  database.instance conf.storage.database, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>check if same status is already set</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    db.value <span class="hljs-string">"""
      SELECT status FROM <span class="hljs-subst">#{prefix}</span>status_check
      WHERE check_id=$1 ORDER BY change DESC
      """</span>, [checkID], <span class="hljs-function"><span class="hljs-params">(err, oldStatus)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">if</span> status <span class="hljs-keyword">is</span> oldStatus
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>insert</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      db.exec <span class="hljs-string">"""
        INSERT INTO <span class="hljs-subst">#{prefix}</span>status_check
        (check_id, change, status, comment) VALUES (?, ?, ?, ?)
        """</span>
      , [checkID, date, status, comment]
      , cb

exports.statusController = <span class="hljs-function"><span class="hljs-params">(controllerID, date, status, cb)</span> -&gt;</span>
  conf ?= config.get <span class="hljs-string">'/monitor'</span>
  <span class="hljs-keyword">return</span> cb() <span class="hljs-keyword">unless</span> conf.storage?.database? <span class="hljs-keyword">and</span> <span class="hljs-keyword">not</span> mode.<span class="hljs-keyword">try</span>
  prefix = conf.storage.prefix
  database.instance conf.storage.database, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>check if same status is already set</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">    db.value <span class="hljs-string">"""
      SELECT status FROM <span class="hljs-subst">#{prefix}</span>status_controller
      WHERE controller_id=$1 ORDER BY change DESC
      """</span>, [controllerID], <span class="hljs-function"><span class="hljs-params">(err, oldStatus)</span> -&gt;</span>
      <span class="hljs-keyword">return</span> cb err <span class="hljs-keyword">if</span> err
      <span class="hljs-keyword">return</span> cb <span class="hljs-literal">null</span>, <span class="hljs-number">0</span> <span class="hljs-keyword">if</span> status <span class="hljs-keyword">is</span> oldStatus
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>insert</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      db.exec <span class="hljs-string">"""
        INSERT INTO <span class="hljs-subst">#{prefix}</span>status_controller
        (controller_id, change, status) VALUES (?, ?, ?)
        """</span>
      , [controllerID, date, status]
      , cb


</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap" id="cleanup-old-data">
  <h2>
    <a href="#cleanup-old-data" name="cleanup-old-data" class="pilcrow"></a>
Cleanup old data
  </h2>
</div>
<p>This is triggered by timeouts of itself, started on storage initialization.
See the configuration at the top of this file.</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript"><span class="hljs-function"><span class="hljs-title">cleanup</span> = <span class="hljs-params">(interval)</span> -&gt;</span>
  setTimeout cleanup, cleanupInterval[interval], interval
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>run the cleanup</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">  prefix = conf.storage.prefix
  database.instance conf.storage.database, <span class="hljs-function"><span class="hljs-params">(err, db)</span> -&gt;</span>
    num = conf.storage.cleanup[interval]
    debug <span class="hljs-string">"remove <span class="hljs-subst">#{interval}</span> entries older than <span class="hljs-subst">#{num}</span> <span class="hljs-subst">#{interval}</span>s"</span>
    <span class="hljs-keyword">if</span> interval <span class="hljs-keyword">is</span> <span class="hljs-string">'other'</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>delete old actions</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      time = moment().subtract(num, <span class="hljs-string">'day'</span>).toDate()
      async.each monitor.listActor(), <span class="hljs-function"><span class="hljs-params">(actor, cb)</span> -&gt;</span>
        db.exec <span class="hljs-string">"DELETE FROM <span class="hljs-subst">#{prefix}</span>actor_<span class="hljs-subst">#{actor}</span> WHERE runAt&lt;?"</span>, [time], cb
      , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>delete old status entries</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">        <span class="hljs-built_in">console</span>.error chalk.red.bold err <span class="hljs-keyword">if</span> err
        async.each [<span class="hljs-string">'check'</span>, <span class="hljs-string">'controller'</span>], <span class="hljs-function"><span class="hljs-params">(type, cb)</span> -&gt;</span>
          db.exec <span class="hljs-string">"DELETE FROM <span class="hljs-subst">#{prefix}</span>status_<span class="hljs-subst">#{type}</span> WHERE change&lt;?"</span>, [time], cb
        , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
          <span class="hljs-built_in">console</span>.error chalk.red.bold err <span class="hljs-keyword">if</span> err
    <span class="hljs-keyword">else</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>for each sensor</p>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">      time = moment().subtract(num, interval).toDate()
      async.each monitor.listSensor(), <span class="hljs-function"><span class="hljs-params">(sensor, cb)</span> -&gt;</span>
        db.exec <span class="hljs-string">"DELETE FROM <span class="hljs-subst">#{prefix}</span>sensor_<span class="hljs-subst">#{sensor}</span> WHERE interval=? AND period&lt;?"</span>
        , [interval, time]
        , cb
      , <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
        <span class="hljs-built_in">console</span>.error chalk.red.bold err <span class="hljs-keyword">if</span> err

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
